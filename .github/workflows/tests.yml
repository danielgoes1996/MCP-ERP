name: Tests

on:
  push:
    branches: [ main, feature/*, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest pytest-cov

    - name: Create test database
      run: |
        touch unified_mcp_system.db
        python -c "import sqlite3; conn = sqlite3.connect('unified_mcp_system.db'); conn.execute('CREATE TABLE IF NOT EXISTS expense_records (id INTEGER PRIMARY KEY, description TEXT, amount REAL, moneda TEXT, workflow_status TEXT, invoice_status TEXT, bank_status TEXT, company_id TEXT, category TEXT, rfc_proveedor TEXT, cfdi_uuid TEXT, metadata TEXT, created_at TEXT, updated_at TEXT, payment_account_id INTEGER, proveedor_nombre TEXT)'); conn.commit(); conn.close()"

    - name: Run tests
      run: |
        # Run all test files
        python3 tests/test_structured_logging.py
        python3 tests/test_duplicate_validation.py
        python3 tests/test_placeholder_full_flow_e2e.py
        python3 tests/test_detailed_stats_endpoint.py
        python3 tests/test_cleanup_script.py

    - name: Test cleanup script dry-run
      run: |
        python3 scripts/cleanup_stale_placeholders.py --dry-run --verbose

    - name: Generate coverage report (if pytest available)
      if: ${{ matrix.python-version == '3.9' }}
      run: |
        # This is optional - requires proper pytest setup
        # pytest --cov=. --cov-report=xml --cov-report=html || true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          *.log
          htmlcov/
        retention-days: 7

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Check code formatting with black
      run: |
        black --check --diff . || true

    - name: Check import sorting with isort
      run: |
        isort --check-only --diff . || true

    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
