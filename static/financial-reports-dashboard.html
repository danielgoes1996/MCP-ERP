<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Fiscales ¬∑ ContaFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/contaflow-theme.css">
    <script src="/static/components/components.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #11446e 0%, #0b3050 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .period-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
        }

        .period-selector select, .period-selector button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .period-selector button {
            background: #11446e;
            color: white;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }

        .period-selector button:hover {
            background: #5a67d8;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .report-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .report-card:hover {
            transform: translateY(-5px);
        }

        .report-card h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .report-card .description {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .report-actions {
            display: flex;
            gap: 10px;
        }

        .report-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .source-filter {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-btn {
            background: #f8fafc;
            border: 1px solid #cbd5f5;
            color: #475569;
            padding: 8px 14px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: #e0e7ff;
            color: #3730a3;
        }

        .filter-btn.active {
            background: #4338ca;
            border-color: #4338ca;
            color: #fff;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.35);
        }

        .source-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 9999px;
            border: 1px solid #e2e8f0;
            font-size: 12px;
            font-weight: 600;
        }

        .source-badge.cfdi {
            background: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }

        .source-badge.rule {
            background: #dbeafe;
            border-color: #93c5fd;
            color: #1d4ed8;
        }

        .source-badge.llm {
            background: #ede9fe;
            border-color: #c4b5fd;
            color: #5b21b6;
        }

        .source-badge.manual {
            background: #fef3c7;
            border-color: #fcd34d;
            color: #92400e;
        }

        .source-badge.unknown {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #475569;
        }

        .btn-generate {
            background: #48bb78;
            color: white;
        }

        .btn-generate:hover {
            background: #38a169;
        }

        .btn-download {
            background: #4299e1;
            color: white;
        }

        .btn-download:hover {
            background: #3182ce;
        }

        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .summary-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
        }

        .metric-card .label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .metric-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .metric-card .change {
            font-size: 12px;
            margin-top: 5px;
        }

        .change.positive {
            color: #48bb78;
        }

        .change.negative {
            color: #f56565;
        }

        .report-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
        }

        .report-viewer.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .report-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f56565;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f7f7f7;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert.warning {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .alert.info {
            background: #bee3f8;
            color: #2a4e7c;
            border-left: 4px solid #4299e1;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #11446e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-options button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-excel {
            background: #1d9f3c;
            color: white;
        }

        .btn-xml {
            background: #ff6b6b;
            color: white;
        }

        .btn-pdf {
            background: #f94144;
            color: white;
        }

        .revision-badge {
            display: inline-block;
            background: #fed7d7;
            color: #742a2a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Global Header -->
    <div data-include="/static/components/global-header.html"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Dashboard de Reportes Fiscales</h1>
            <p style="color: #666;">Generaci√≥n autom√°tica de reportes fiscales y contables</p>
            <a href="/docs/fiscal_pipeline.md" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;color:#4338ca;font-size:14px;font-weight:600;margin-top:12px;text-decoration:none;">
                <i class="fas fa-book"></i> Gu√≠a de trazabilidad fiscal
            </a>

            <div class="period-selector">
                <select id="yearSelect">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
                <select id="monthSelect">
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
                <button onclick="updatePeriod()">Actualizar Periodo</button>
                <button onclick="loadFiscalSummary()" style="background: #f6ad55;">Ver Resumen Fiscal</button>
            </div>
        </div>

        <!-- Resumen Fiscal -->
        <div class="summary-section" id="summarySection">
            <h2>Resumen Fiscal del Periodo</h2>
            <div class="source-filter" id="taxSourceFilter">
                <button class="filter-btn active" data-source="all" onclick="changeTaxSource('all')">Todos</button>
                <button class="filter-btn" data-source="cfdi" onclick="changeTaxSource('cfdi')">CFDI</button>
                <button class="filter-btn" data-source="rule" onclick="changeTaxSource('rule')">Reglas</button>
                <button class="filter-btn" data-source="llm" onclick="changeTaxSource('llm')">IA</button>
                <button class="filter-btn" data-source="manual" onclick="changeTaxSource('manual')">Manual</button>
            </div>
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card">
                    <div class="label">Total Gastos</div>
                    <div class="value" id="totalGastos">$0</div>
                    <div class="change positive">‚Üë 0% vs mes anterior</div>
                </div>
                <div class="metric-card">
                    <div class="label">IVA Acreditable</div>
                    <div class="value" id="ivaAcreditable">$0</div>
                </div>
                <div class="metric-card">
                    <div class="label">IVA No Acreditable</div>
                    <div class="value" id="ivaNoAcreditable">$0</div>
                </div>
                <div class="metric-card">
                    <div class="label">Gastos con CFDI</div>
                    <div class="value" id="gastosConCfdi">0%</div>
                </div>
                <div class="metric-card">
                    <div class="label">Requieren Revisi√≥n</div>
                    <div class="value" id="gastosRevision">0</div>
                    <div class="change negative">Pendientes de revisar</div>
                </div>
                <div class="metric-card" id="sourceCounters">
                    <div class="label">Fuentes fiscales</div>
                    <div class="source-badges" id="sourceBadges">
                        <span class="text-xs text-slate-500">Sin informaci√≥n disponible</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid de Reportes -->
        <div class="report-grid">
            <!-- Reporte IVA -->
            <div class="report-card">
                <h2>üìã Reporte de IVA</h2>
                <p class="description">
                    Clasificaci√≥n autom√°tica de IVA acreditable y no acreditable seg√∫n categor√≠as SAT y r√©gimen fiscal.
                </p>
                <div class="report-actions">
                    <button class="btn-generate" onclick="generateReport('iva')">Generar</button>
                    <button class="btn-download" onclick="downloadReport('iva', 'excel')">Excel</button>
                </div>
            </div>

            <!-- P√≥liza Electr√≥nica -->
            <div class="report-card">
                <h2>üìë P√≥liza Electr√≥nica</h2>
                <p class="description">
                    Genera p√≥lizas contables en formato Anexo 24 del SAT, listas para firma electr√≥nica.
                </p>
                <div class="report-actions">
                    <button class="btn-generate" onclick="generateReport('poliza')">Generar</button>
                    <button class="btn-download" onclick="downloadPoliza('xml')">XML SAT</button>
                </div>
            </div>

            <!-- Gastos en Revisi√≥n -->
            <div class="report-card">
                <h2>‚ö†Ô∏è Gastos en Revisi√≥n</h2>
                <p class="description">
                    Lista de gastos que requieren atenci√≥n por categor√≠as ambiguas o restricciones fiscales.
                </p>
                <div class="report-actions">
                    <button class="btn-generate" onclick="generateReport('revision')">Ver Lista</button>
                    <button class="btn-download" onclick="downloadReport('revision', 'excel')">Exportar</button>
                </div>
            </div>

            <!-- Categor√≠as SAT -->
            <div class="report-card">
                <h2>üìä Por Categor√≠as SAT</h2>
                <p class="description">
                    Resumen de gastos agrupados por categor√≠a y c√≥digo SAT del cat√°logo de cuentas.
                </p>
                <div class="report-actions">
                    <button class="btn-generate" onclick="generateReport('categorias')">Analizar</button>
                    <button class="btn-download" onclick="downloadReport('categorias', 'excel')">Excel</button>
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div id="alertsSection"></div>
    </div>

    <!-- Visor de Reportes -->
    <div class="report-viewer" id="reportViewer">
        <div class="report-content">
            <button class="close-btn" onclick="closeReportViewer()">√ó</button>
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n global - Usar siempre el puerto del servidor
        const currentPort = window.location.port || 8001;
        const API_BASE = `http://localhost:${currentPort || 8001}/api/v1/reports`;
        let currentTaxSource = 'all';
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;

        console.log('Configuraci√≥n del Dashboard:');
        console.log('- Puerto detectado:', currentPort);
        console.log('- API Base URL:', API_BASE);
        console.log('- Periodo inicial:', currentYear + '-' + currentMonth);

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando dashboard fiscal...');
            console.log('A√±o:', currentYear, 'Mes:', currentMonth);

            setActiveTaxSourceButton();

            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;

            // Cargar datos iniciales
            loadFiscalSummary();
        });

        function setActiveTaxSourceButton() {
            const buttons = document.querySelectorAll('#taxSourceFilter .filter-btn');
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.source === currentTaxSource);
            });
        }

        function changeTaxSource(source) {
            currentTaxSource = source;
            setActiveTaxSourceButton();
            loadFiscalSummary();
        }

        // Actualizar periodo seleccionado
        function updatePeriod() {
            currentYear = parseInt(document.getElementById('yearSelect').value);
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            loadFiscalSummary();
        }

        // Cargar resumen fiscal
        async function loadFiscalSummary() {
            try {
                console.log('Cargando resumen fiscal...');
                showLoading('metricsGrid');
                setActiveTaxSourceButton();

                const url = `${API_BASE}/resumen-fiscal?year=${currentYear}&month=${currentMonth}&tax_source=${currentTaxSource}`;
                console.log('URL:', url);

                const response = await fetch(url);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('Datos recibidos:', data);

                updateMetrics(data);
                updateAlerts(data.alertas);

            } catch (error) {
                console.error('Error completo:', error);
                document.getElementById('metricsGrid').innerHTML =
                    `<div style="color: red; padding: 20px;">
                        <h3>Error cargando datos</h3>
                        <p>${error.message}</p>
                        <p>Revisa la consola del navegador para m√°s detalles</p>
                    </div>`;
            }
        }

        // Actualizar m√©tricas
        function updateMetrics(data) {
            try {
                // Verificar que los elementos existan antes de actualizar
                const totalGastosEl = document.getElementById('totalGastos');
                const ivaAcreditableEl = document.getElementById('ivaAcreditable');
                const ivaNoAcreditableEl = document.getElementById('ivaNoAcreditable');
                const gastosConCfdiEl = document.getElementById('gastosConCfdi');
                const gastosRevisionEl = document.getElementById('gastosRevision');

                if (totalGastosEl) totalGastosEl.textContent = formatCurrency(data.totales.gastos_total);
                if (ivaAcreditableEl) ivaAcreditableEl.textContent = formatCurrency(data.totales.iva_acreditable);
                if (ivaNoAcreditableEl) ivaNoAcreditableEl.textContent = formatCurrency(data.totales.iva_no_acreditable);
                if (gastosConCfdiEl) gastosConCfdiEl.textContent = `${data.cfdi.porcentaje_cfdi.toFixed(1)}%`;
                if (gastosRevisionEl) gastosRevisionEl.textContent = data.revision.total;

                console.log('M√©tricas actualizadas correctamente');

                const badgesContainer = document.getElementById('sourceBadges');
                if (badgesContainer) {
                    const statsRaw = data.tax_sources || data.fuentes || data.fuente || null;
                    const formatLabel = (key) => {
                        switch ((key || '').toLowerCase()) {
                            case 'cfdi':
                                return 'CFDI';
                            case 'rule':
                                return 'Reglas';
                            case 'llm':
                                return 'IA';
                            case 'manual':
                                return 'Manual';
                            default:
                                return key || 'Desconocido';
                        }
                    };

                    const entries = [];
                    if (Array.isArray(statsRaw)) {
                        statsRaw.forEach(item => {
                            entries.push({
                                key: (item.key || item.fuente || item.nombre || 'unknown').toLowerCase(),
                                label: item.label || item.nombre || formatLabel(item.key || item.fuente),
                                total: item.total || item.monto || item.cantidad || 0,
                                percentage: typeof item.porcentaje === 'number' ? item.porcentaje : (typeof item.percentage === 'number' ? item.percentage : null)
                            });
                        });
                    } else if (statsRaw && typeof statsRaw === 'object') {
                        Object.entries(statsRaw).forEach(([key, value]) => {
                            entries.push({
                                key: key.toLowerCase(),
                                label: value.label || formatLabel(key),
                                total: value.total || value.monto || value.cantidad || 0,
                                percentage: typeof value.porcentaje === 'number' ? value.porcentaje : (typeof value.percentage === 'number' ? value.percentage : null)
                            });
                        });
                    }

                    if (entries.length === 0) {
                        badgesContainer.innerHTML = '<span class="text-xs text-slate-500">Sin informaci√≥n de fuentes fiscales</span>';
                    } else {
                        badgesContainer.innerHTML = entries.map(entry => {
                            const cssClass = ['cfdi','rule','llm','manual'].includes(entry.key) ? entry.key : 'unknown';
                            const totalFormatted = typeof entry.total === 'number' ? entry.total.toLocaleString('es-MX', { minimumFractionDigits: 0 }) : entry.total;
                            const pctFormatted = typeof entry.percentage === 'number' ? ` (${entry.percentage.toFixed(1)}%)` : '';
                            return `<span class="source-badge ${cssClass}">${entry.label}: ${totalFormatted}${pctFormatted}</span>`;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Error actualizando m√©tricas:', error);
                // No sobrescribir el HTML si hay error
            }
        }

        // Actualizar alertas
        function updateAlerts(alertas) {
            const alertsSection = document.getElementById('alertsSection');
            alertsSection.innerHTML = '';

            if (alertas && alertas.length > 0) {
                const container = document.createElement('div');
                container.className = 'summary-section';
                container.innerHTML = '<h2>‚ö†Ô∏è Alertas y Recomendaciones</h2>';

                alertas.forEach(alerta => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert ${alerta.tipo}`;
                    alertDiv.innerHTML = `
                        <strong>${alerta.mensaje}</strong>
                        ${alerta.recomendacion ? `<br><small>Recomendaci√≥n: ${alerta.recomendacion}</small>` : ''}
                        ${alerta.monto ? `<br>Monto: ${formatCurrency(alerta.monto)}` : ''}
                    `;
                    container.appendChild(alertDiv);
                });

                alertsSection.appendChild(container);
            }
        }

        // Generar reporte
        async function generateReport(type) {
            try {
                const reportContent = document.getElementById('reportContent');
                showReportViewer();
                showLoading('reportContent');

                let url = '';
                switch(type) {
                    case 'iva':
                        url = `${API_BASE}/iva`;
                        const ivaData = { year: currentYear, month: currentMonth, report_type: 'iva', detailed: true, tax_source: currentTaxSource };
                        const ivaResponse = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(ivaData)
                        });
                        const ivaReport = await ivaResponse.json();
                        displayIVAReport(ivaReport);
                        break;

                    case 'poliza':
                        url = `${API_BASE}/poliza-electronica?year=${currentYear}&month=${currentMonth}&tipo_poliza=Dr&tax_source=${currentTaxSource}`;
                        const polizaResponse = await fetch(url, { method: 'POST' });
                        const polizaData = await polizaResponse.json();
                        displayPolizaReport(polizaData);
                        break;

                    case 'revision':
                        url = `${API_BASE}/gastos-revision?year=${currentYear}&month=${currentMonth}&tax_source=${currentTaxSource}`;
                        const revisionResponse = await fetch(url);
                        const revisionData = await revisionResponse.json();
                        displayRevisionReport(revisionData);
                        break;

                    case 'categorias':
                        url = `${API_BASE}/categorias-sat/resumen?year=${currentYear}&month=${currentMonth}&tax_source=${currentTaxSource}`;
                        const categoriasResponse = await fetch(url);
                        const categoriasData = await categoriasResponse.json();
                        displayCategoriasReport(categoriasData);
                        break;
                }

            } catch (error) {
                console.error('Error generando reporte:', error);
                showError('Error generando el reporte');
            }
        }

        // Mostrar reporte de IVA
        function displayIVAReport(data) {
            const content = `
                <h2>Reporte de IVA - ${getMonthName(currentMonth)} ${currentYear}</h2>

                <div class="metrics-grid" style="margin: 20px 0;">
                    <div class="metric-card">
                        <div class="label">IVA Acreditable 16%</div>
                        <div class="value">${formatCurrency(data.resumen.iva_acreditable_16)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">IVA Acreditable 8%</div>
                        <div class="value">${formatCurrency(data.resumen.iva_acreditable_8)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">IVA No Acreditable</div>
                        <div class="value">${formatCurrency(data.resumen.iva_no_acreditable)}</div>
                    </div>
                </div>

                ${data.detalle ? `
                    <h3>Detalle de Gastos</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Proveedor</th>
                                    <th>Descripci√≥n</th>
                                    <th>Subtotal</th>
                                    <th>IVA</th>
                                    <th>Total</th>
                                    <th>Clasificaci√≥n</th>
                                    <th>CFDI</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.detalle.map(item => `
                                    <tr>
                                        <td>${item.fecha_gasto}</td>
                                        <td>${item.proveedor}</td>
                                        <td>${item.descripcion}</td>
                                        <td>${formatCurrency(item.subtotal)}</td>
                                        <td>${formatCurrency(item.iva)}</td>
                                        <td>${formatCurrency(item.total)}</td>
                                        <td>${getIVALabel(item.iva_category)}</td>
                                        <td>${item.cfdi_uuid ? '‚úÖ' : '‚ùå'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}

                <div class="export-options">
                    <button class="btn-excel" onclick="downloadReport('iva', 'excel')">üì• Descargar Excel</button>
                </div>
            `;
            document.getElementById('reportContent').innerHTML = content;
        }

        // Mostrar reporte de p√≥liza
        function displayPolizaReport(data) {
            const content = `
                <h2>P√≥liza Electr√≥nica - ${getMonthName(currentMonth)} ${currentYear}</h2>
                <p>RFC: ${data.RFC} | Versi√≥n: ${data.Version}</p>

                <div class="alert info">
                    Esta p√≥liza est√° en formato Anexo 24 del SAT y est√° lista para firma electr√≥nica.
                </div>

                <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto;">
${JSON.stringify(data.Polizas, null, 2)}
                </pre>

                <div class="export-options">
                    <button class="btn-xml" onclick="downloadPoliza('xml')">üì• Descargar XML</button>
                </div>
            `;
            document.getElementById('reportContent').innerHTML = content;
        }

        // Mostrar reporte de revisi√≥n
        function displayRevisionReport(data) {
            const content = `
                <h2>Gastos en Revisi√≥n</h2>
                <p>Total: ${data.total_gastos_revision} gastos | Monto: ${formatCurrency(data.monto_total_revision)}</p>

                <h3>Razones Frecuentes</h3>
                <ul>
                    ${Object.entries(data.razones_frecuentes).map(([razon, count]) =>
                        `<li>${razon}: ${count} casos</li>`
                    ).join('')}
                </ul>

                <h3>Detalle de Gastos</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Descripci√≥n</th>
                                <th>Monto</th>
                                <th>Categor√≠a</th>
                                <th>Razones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.gastos.map(item => `
                                <tr>
                                    <td>${item.fecha}</td>
                                    <td>${item.proveedor}</td>
                                    <td>${item.descripcion}</td>
                                    <td>${formatCurrency(item.monto)}</td>
                                    <td>${item.categoria}<span class="revision-badge">Revisar</span></td>
                                    <td>${item.razones_revision.join('<br>')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('reportContent').innerHTML = content;
        }

        // Mostrar reporte de categor√≠as
        function displayCategoriasReport(data) {
            const content = `
                <h2>Gastos por Categor√≠as SAT</h2>
                <p>Total General: ${formatCurrency(data.total_general)}</p>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Categor√≠a</th>
                                <th>C√≥digo SAT</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>% del Total</th>
                                <th>% con CFDI</th>
                                <th>% Revisi√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.categorias.map(item => `
                                <tr>
                                    <td>${item.categoria.nombre}</td>
                                    <td>${item.categoria.sat_account_code || 'N/A'}</td>
                                    <td>${item.estadisticas.cantidad_gastos}</td>
                                    <td>${formatCurrency(item.estadisticas.total)}</td>
                                    <td>${item.estadisticas.porcentaje_total.toFixed(1)}%</td>
                                    <td>${item.estadisticas.porcentaje_cfdi.toFixed(1)}%</td>
                                    <td>${item.estadisticas.porcentaje_revision.toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('reportContent').innerHTML = content;
        }

        // Descargar reporte
        function downloadReport(type, format) {
            alert(`Descarga de ${type} en formato ${format} - Funcionalidad en desarrollo`);
            // TODO: Implementar descarga real cuando se agregue soporte backend
        }

        // Descargar p√≥liza XML
        async function downloadPoliza(format) {
            try {
            const url = `${API_BASE}/poliza-electronica/xml?year=${currentYear}&month=${currentMonth}&tipo_poliza=Dr&tax_source=${currentTaxSource}`;
                window.open(url, '_blank');
            } catch (error) {
                console.error('Error descargando p√≥liza:', error);
            }
        }

        // Utilidades UI
        function showReportViewer() {
            document.getElementById('reportViewer').classList.add('active');
        }

        function closeReportViewer() {
            document.getElementById('reportViewer').classList.remove('active');
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        }

        function showError(message) {
            alert(message);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount || 0);
        }

        function getMonthName(month) {
            const months = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return months[month];
        }

        function getIVALabel(category) {
            const labels = {
                'acreditable_16': 'Acreditable 16%',
                'acreditable_8': 'Acreditable 8%',
                'no_acreditable': 'No Acreditable',
                'exento': 'Exento',
                'tasa_0': 'Tasa 0%'
            };
            return labels[category] || category;
        }
    </script>
</body>
</html>
