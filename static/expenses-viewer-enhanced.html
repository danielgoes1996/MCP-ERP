<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Gastos Â· ContaFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/contaflow-theme.css">
    <script src="/static/components/components.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-100">
    <!-- Global Header -->
    <div data-include="/static/components/global-header.html"></div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const getTaxSourceConfig = (source) => {
            switch ((source || '').toLowerCase()) {
                case 'cfdi':
                    return { label: 'CFDI', badgeClass: 'bg-green-100 text-green-700 border border-green-200', icon: 'fa-file-invoice' };
                case 'rule':
                    return { label: 'Regla', badgeClass: 'bg-blue-100 text-blue-700 border border-blue-200', icon: 'fa-sliders-h' };
                case 'llm':
                    return { label: 'IA', badgeClass: 'bg-purple-100 text-purple-700 border border-purple-200', icon: 'fa-robot' };
                case 'manual':
                    return { label: 'Manual', badgeClass: 'bg-amber-100 text-amber-700 border border-amber-200', icon: 'fa-user-edit' };
                default:
                    return { label: 'Desconocido', badgeClass: 'bg-gray-100 text-gray-600 border border-gray-200', icon: 'fa-question-circle' };
            }
        };

        // Componente de desglose de impuestos
        const TaxBreakdown = ({ expense }) => {
            const [isOpen, setIsOpen] = useState(false);
            const hasBreakdown = expense.subtotal || expense.iva_16 || expense.iva_8 || expense.ieps;

            if (!hasBreakdown) return null;

            const formatMoney = (amount) => {
                if (!amount) return '$0.00';
                return `$${parseFloat(amount).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
            };

            return (
                <div className="inline-flex flex-col">
                    <button
                        type="button"
                        onClick={() => setIsOpen(!isOpen)}
                        className="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1"
                    >
                        <i className={`fas fa-chevron-${isOpen ? 'up' : 'down'}`}></i>
                        Desglose
                    </button>
                    {isOpen && (
                        <div className="mt-2 p-3 bg-slate-100 rounded-lg border border-slate-200 text-xs space-y-1 min-w-[200px]">
                            <div className="flex justify-between">
                                <span className="text-gray-600">Subtotal:</span>
                                <span className="font-semibold">{formatMoney(expense.subtotal)}</span>
                            </div>
                            {expense.iva_16 > 0 && (
                                <div className="flex justify-between">
                                    <span className="text-gray-600">IVA 16%:</span>
                                    <span className="font-semibold">{formatMoney(expense.iva_16)}</span>
                                </div>
                            )}
                            {expense.iva_8 > 0 && (
                                <div className="flex justify-between">
                                    <span className="text-gray-600">IVA 8%:</span>
                                    <span className="font-semibold">{formatMoney(expense.iva_8)}</span>
                                </div>
                            )}
                            {expense.ieps > 0 && (
                                <div className="flex justify-between">
                                    <span className="text-gray-600">IEPS:</span>
                                    <span className="font-semibold">{formatMoney(expense.ieps)}</span>
                                </div>
                            )}
                            {expense.isr_retenido > 0 && (
                                <div className="flex justify-between text-red-600">
                                    <span>ISR Retenido:</span>
                                    <span className="font-semibold">-{formatMoney(expense.isr_retenido)}</span>
                                </div>
                            )}
                            <div className="pt-2 mt-2 border-t border-slate-300 flex justify-between font-bold">
                                <span>Total:</span>
                                <span>{formatMoney(expense.amount || expense.monto_total)}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Componente de badges de impuestos
        const TaxBadges = ({ expense }) => {
            let impuestos = [];

            try {
                if (expense.impuestos_incluidos) {
                    impuestos = JSON.parse(expense.impuestos_incluidos);
                }
            } catch (e) {
                if (expense.iva_16 > 0) impuestos.push('IVA 16%');
                if (expense.iva_8 > 0) impuestos.push('IVA 8%');
                if (expense.ieps > 0) impuestos.push('IEPS');
            }

            if (impuestos.length === 0) return <span className="text-gray-400 text-xs">Sin impuestos</span>;

            return (
                <div className="flex flex-wrap gap-1">
                    {impuestos.map((impuesto, index) => (
                        <span key={index} className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                            {impuesto}
                        </span>
                    ))}
                </div>
            );
        };

        // Componente de estado CFDI con drag & drop
        const CFDIStatus = ({ expense, onUpload }) => {
            const [isDragging, setIsDragging] = useState(false);

            const handleDrop = async (e) => {
                e.preventDefault();
                setIsDragging(false);

                const files = Array.from(e.dataTransfer.files);
                const pdfFile = files.find(f => f.name.toLowerCase().endsWith('.pdf'));
                const xmlFile = files.find(f => f.name.toLowerCase().endsWith('.xml'));

                if (pdfFile || xmlFile) {
                    const formData = new FormData();
                    if (pdfFile) formData.append('pdf_file', pdfFile);
                    if (xmlFile) formData.append('xml_file', xmlFile);

                    try {
                        const response = await fetch(`/expenses/${expense.id}/upload-cfdi`, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert('âœ… CFDI cargado exitosamente');
                            if (onUpload) onUpload(result);
                        } else {
                            alert('âŒ Error al cargar CFDI');
                        }
                    } catch (error) {
                        console.error('Error uploading CFDI:', error);
                        alert('âŒ Error de conexiÃ³n');
                    }
                }
            };

            const getStatusConfig = () => {
                switch (expense.cfdi_status) {
                    case 'factura_lista':
                        return { label: 'Factura lista', icon: 'fa-check-circle', bgClass: 'bg-green-100', textClass: 'text-green-700' };
                    case 'en_proceso':
                        return { label: 'En proceso', icon: 'fa-clock', bgClass: 'bg-yellow-100', textClass: 'text-yellow-700' };
                    case 'no_facturar':
                        return { label: 'No se facturarÃ¡', icon: 'fa-ban', bgClass: 'bg-gray-100', textClass: 'text-gray-700' };
                    default:
                        return { label: 'No disponible', icon: 'fa-file-invoice', bgClass: 'bg-red-50', textClass: 'text-red-700' };
                }
            };

            const status = getStatusConfig();

            if (expense.cfdi_status === 'factura_lista' && (expense.cfdi_pdf_url || expense.cfdi_xml_url)) {
                return (
                    <div className="flex flex-col gap-1">
                        <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${status.bgClass} ${status.textClass}`}>
                            <i className={`fas ${status.icon}`}></i>
                            {status.label}
                        </span>
                        <div className="flex gap-2">
                            {expense.cfdi_pdf_url && (
                                <a href={expense.cfdi_pdf_url} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline">
                                    <i className="fas fa-file-pdf"></i> PDF
                                </a>
                            )}
                            {expense.cfdi_xml_url && (
                                <a href={expense.cfdi_xml_url} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline">
                                    <i className="fas fa-file-code"></i> XML
                                </a>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div
                    onDrop={handleDrop}
                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                    onDragLeave={() => setIsDragging(false)}
                    className={`flex flex-col gap-1 p-2 rounded-lg border-2 border-dashed transition-colors ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}`}
                >
                    <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${status.bgClass} ${status.textClass}`}>
                        <i className={`fas ${status.icon}`}></i>
                        {status.label}
                    </span>
                    <span className="text-xs text-gray-500">
                        {isDragging ? 'ðŸ“Ž Suelta aquÃ­' : 'ðŸ“Ž Arrastra PDF/XML'}
                    </span>
                </div>
            );
        };

        // Componente principal
        const ExpensesViewerEnhanced = () => {
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [traceabilityExpense, setTraceabilityExpense] = useState(null);
            const [classificationExpense, setClassificationExpense] = useState(null);
            const [satOptions, setSatOptions] = useState([]);
            const [satSearchTerm, setSatSearchTerm] = useState('');
            const [selectedSatCode, setSelectedSatCode] = useState('');
            const [classificationNotes, setClassificationNotes] = useState('');
            const [classificationError, setClassificationError] = useState(null);
            const [isSavingClassification, setIsSavingClassification] = useState(false);

            useEffect(() => {
                fetchExpenses();
            }, []);

            const fetchExpenses = async () => {
                try {
                    const response = await fetch('/expenses?company_id=default');
                    const data = await response.json();
                    setExpenses(data);
                    setLoading(false);
                } catch (error) {
                    console.error('Error:', error);
                    setLoading(false);
                }
            };

            const fetchSatAccounts = async (searchTerm = '') => {
                try {
                    const params = new URLSearchParams();
                    if (searchTerm) {
                        params.set('search', searchTerm);
                    }
                    const response = await fetch(`/sat-accounts?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error('No se pudo cargar el catÃ¡logo SAT');
                    }
                    const data = await response.json();
                    setSatOptions(data);
                } catch (error) {
                    console.error('Error cargando catÃ¡logo SAT:', error);
                    setClassificationError(error.message);
                }
            };

            const formatCurrency = (amount) => {
                if (!amount) return '$0.00';
                return `$${parseFloat(amount).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
            };

            const handleFacturarChange = async (expenseId, value) => {
                try {
                    const response = await fetch(`/expenses/${expenseId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requiere_factura: value === 'si',
                            cfdi_status: value === 'si' ? 'en_proceso' : 'no_facturar'
                        })
                    });

                    if (response.ok) {
                        fetchExpenses();
                    } else {
                        alert('Error al actualizar');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            };

            const openClassificationModal = (expense) => {
                setClassificationExpense(expense);
                setSelectedSatCode(expense.sat_account_code || '');
                setClassificationNotes('');
                setSatSearchTerm('');
                setClassificationError(null);
                fetchSatAccounts('');
            };

            const closeClassificationModal = () => {
                setClassificationExpense(null);
                setSatOptions([]);
                setSelectedSatCode('');
                setClassificationNotes('');
                setSatSearchTerm('');
                setClassificationError(null);
            };

            const handleSaveClassification = async () => {
                if (!classificationExpense || !selectedSatCode) {
                    setClassificationError('Selecciona una cuenta SAT antes de guardar.');
                    return;
                }

                setIsSavingClassification(true);
                setClassificationError(null);
                try {
                    const response = await fetch(`/expenses/${classificationExpense.id}/classification-feedback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sat_account_code: selectedSatCode,
                            categoria_contable: classificationExpense.categoria || null,
                            categoria_slug: classificationExpense.categoria_slug || null,
                            notes: classificationNotes || null,
                            descripcion: classificationExpense.descripcion || null
                        })
                    });

                    if (!response.ok) {
                        const detail = await response.json().catch(() => ({}));
                        throw new Error(detail.detail || 'No se pudo registrar la correcciÃ³n');
                    }

                    alert('âœ… CorrecciÃ³n guardada. Gracias por el feedback.');
                    closeClassificationModal();
                    fetchExpenses();
                } catch (error) {
                    console.error('Error guardando feedback de clasificaciÃ³n:', error);
                    setClassificationError(error.message);
                } finally {
                    setIsSavingClassification(false);
                }
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <div className="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                    </div>
                );
            }

            return (
                <>
                <div className="min-h-screen p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="mb-6">
                            <h1 className="text-3xl font-bold text-gray-900">ðŸ“Š Visor de Gastos Mejorado</h1>
                            <p className="text-gray-600">Con desglose de impuestos, CFDI y gestiÃ³n completa</p>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-slate-100">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DescripciÃ³n</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CÃ³digos SAT</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuente fiscal</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confianza</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MÃ©todo de pago</th>
                                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto total</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impuestos</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comprobante</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CFDI</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Â¿Facturar?</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {expenses.map((expense) => (
                                            <tr key={expense.id} className="hover:bg-slate-100">
                                                <td className="px-4 py-3">
                                                    <div className="flex flex-col gap-1">
                                                        <span className="text-sm font-medium text-gray-900">{expense.description || expense.descripcion || 'Sin descripciÃ³n'}</span>
                                                        {expense.merchant_name && (
                                                            <span className="text-xs text-gray-500">
                                                                <i className="fas fa-building mr-1"></i>
                                                                {expense.merchant_name}
                                                            </span>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="flex flex-col gap-1">
                                                        {expense.sat_account_code && (
                                                            <span className="text-xs">
                                                                <span className="font-medium text-gray-600">Cuenta:</span>
                                                                <span className="ml-1 px-2 py-0.5 bg-purple-100 text-purple-700 rounded">{expense.sat_account_code}</span>
                                                            </span>
                                                        )}
                                                        {expense.sat_product_service_code && (
                                                            <span className="text-xs">
                                                                <span className="font-medium text-gray-600">Servicio:</span>
                                                                <span className="ml-1 px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded">{expense.sat_product_service_code}</span>
                                                            </span>
                                                        )}
                                                        {!expense.sat_account_code && !expense.sat_product_service_code && (
                                                            <span className="text-xs text-gray-400">Sin cÃ³digos SAT</span>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3">
                                                    {(() => {
                                                        const config = getTaxSourceConfig(expense.tax_source);
                                                        const explanation = expense.explanation_short || 'Sin explicaciÃ³n disponible';
                                                        const sourceDetail = expense.classification_source ? `Origen: ${expense.classification_source}` : 'Origen no especificado';
                                                        return (
                                                            <div className="flex flex-col gap-1">
                                                                <span
                                                                    className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${config.badgeClass}`}
                                                                    title={`${config.label}\n${sourceDetail}\n${explanation}`}
                                                                >
                                                                    <i className={`fas ${config.icon}`}></i>
                                                                    {config.label}
                                                                </span>
                                                                <span className="text-[10px] text-slate-400">
                                                                    {sourceDetail} Â· CatÃ¡logo: {expense.catalog_version || 'v1'}
                                                                </span>
                                                            </div>
                                                        );
                                                    })()}
                                                </td>
                                                <td className="px-4 py-3">
                                                    {typeof expense.categoria_confianza === 'number' ? (
                                                        <span className="inline-flex items-center gap-1 text-xs text-gray-700">
                                                            <i className={`fas ${expense.categoria_confianza >= 0.8 ? 'fa-check-circle text-green-500' : expense.categoria_confianza >= 0.5 ? 'fa-exclamation-circle text-amber-500' : 'fa-times-circle text-red-500'}`}></i>
                                                            {Math.round(expense.categoria_confianza * 100)}%
                                                        </span>
                                                    ) : (
                                                        <span className="text-xs text-gray-400">N/D</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3">
                                                    <span className="text-sm text-gray-700">
                                                        {expense.metodo_pago || 'No especificado'}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <div className="flex flex-col items-end gap-1">
                                                        <span className="text-sm font-semibold text-gray-900">{formatCurrency(expense.amount || expense.monto_total)}</span>
                                                        <TaxBreakdown expense={expense} />
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3">
                                                    <TaxBadges expense={expense} />
                                                </td>
                                                <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                                    {expense.date || expense.fecha_gasto || 'Sin fecha'}
                                                </td>
                                                <td className="px-4 py-3">
                                                    {expense.ticket_image_url ? (
                                                        <a href={expense.ticket_image_url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs">
                                                            <i className="fas fa-image"></i>
                                                            Ver adjunto
                                                        </a>
                                                    ) : (
                                                        <span className="text-xs text-gray-400">
                                                            {expense.registro_via === 'voz' ? 'Por voz' : 'Sin adjunto'}
                                                        </span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3">
                                                    <CFDIStatus expense={expense} onUpload={fetchExpenses} />
                                                </td>
                                                <td className="px-4 py-3">
                                                    <select
                                                        value={expense.requiere_factura ? 'si' : 'no'}
                                                        onChange={(e) => handleFacturarChange(expense.id, e.target.value)}
                                                        className="text-sm border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-500"
                                                    >
                                                        <option value="si">SÃ­</option>
                                                        <option value="no">No</option>
                                                    </select>
                                                </td>
                                                <td className="px-4 py-3 text-center">
                                                    <div className="flex items-center justify-center gap-2">
                                                        <button
                                                            type="button"
                                                            onClick={() => openClassificationModal(expense)}
                                                            className="inline-flex items-center justify-center h-8 w-8 rounded-full hover:bg-indigo-50 text-indigo-600"
                                                            title="Corregir SAT"
                                                        >
                                                            <i className="fas fa-edit"></i>
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => setTraceabilityExpense(expense)}
                                                            className="inline-flex items-center justify-center h-8 w-8 rounded-full hover:bg-gray-100 text-blue-600"
                                                            title="Ver trazabilidad fiscal"
                                                        >
                                                            <i className="fas fa-route"></i>
                                                        </button>
                                                        <button
                                                            type="button"
                                                            onClick={() => window.open(`/voice-expenses?expense_id=${expense.id}`, '_blank')}
                                                            className="inline-flex items-center justify-center h-8 w-8 rounded-full hover:bg-gray-100 text-gray-500"
                                                            title="Abrir en captura"
                                                        >
                                                            <i className="fas fa-external-link-alt"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {expenses.length === 0 && (
                                <div className="p-12 text-center text-gray-500">
                                    <i className="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                                    <p>No hay gastos registrados</p>
                                </div>
                            )}
                        </div>

                        <div className="mt-6 flex justify-between items-center">
                            <a href="/voice-expenses" className="text-blue-600 hover:text-blue-800">
                                <i className="fas fa-arrow-left mr-2"></i>
                                Volver a captura de gastos
                            </a>
                            <p className="text-sm text-gray-500">
                                Total: {expenses.length} gasto{expenses.length !== 1 ? 's' : ''}
                            </p>
                        </div>
                    </div>
                </div>

                {classificationExpense && (
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50">
                        <div className="bg-white rounded-xl shadow-2xl max-w-xl w-full mx-4">
                            <div className="px-6 py-4 border-b border-slate-200 flex items-start justify-between">
                                <div>
                                    <h3 className="text-lg font-semibold text-slate-900 flex items-center gap-2">
                                        <i className="fas fa-magic text-indigo-600"></i>
                                        Corregir clasificaciÃ³n SAT
                                    </h3>
                                    <p className="text-sm text-slate-500">
                                        {classificationExpense.descripcion || 'Gasto sin descripciÃ³n'}
                                    </p>
                                </div>
                                <button
                                    onClick={closeClassificationModal}
                                    className="text-slate-400 hover:text-slate-600"
                                >
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            <div className="px-6 py-5 space-y-4">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={satSearchTerm}
                                        onChange={(e) => setSatSearchTerm(e.target.value)}
                                        placeholder="Buscar por cÃ³digo o nombre"
                                        className="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                    <button
                                        onClick={() => fetchSatAccounts(satSearchTerm)}
                                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm"
                                    >
                                        Buscar
                                    </button>
                                </div>
                                <div className="max-h-48 overflow-y-auto border border-slate-200 rounded-lg divide-y divide-slate-100 text-sm">
                                    {satOptions.length ? satOptions.map((account) => (
                                        <label key={account.code} className="flex items-start gap-3 px-3 py-2 hover:bg-indigo-50 cursor-pointer">
                                            <input
                                                type="radio"
                                                className="mt-1"
                                                name="sat-account"
                                                value={account.code}
                                                checked={selectedSatCode === account.code}
                                                onChange={() => setSelectedSatCode(account.code)}
                                            />
                                            <div>
                                                <p className="font-medium text-slate-900">{account.code} â€” {account.name}</p>
                                                {account.description && (
                                                    <p className="text-xs text-slate-500">{account.description}</p>
                                                )}
                                            </div>
                                        </label>
                                    )) : (
                                        <p className="px-3 py-6 text-center text-slate-500">Sin resultados. Ajusta tu bÃºsqueda.</p>
                                    )}
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Notas (opcional)</label>
                                    <textarea
                                        rows="3"
                                        value={classificationNotes}
                                        onChange={(e) => setClassificationNotes(e.target.value)}
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        placeholder="Ej. Regalo corporativo, usar Gastos de representaciÃ³n"
                                    ></textarea>
                                </div>
                                {classificationError && (
                                    <p className="text-sm text-red-600">{classificationError}</p>
                                )}
                            </div>
                            <div className="px-6 py-4 bg-slate-100 border-t border-slate-200 flex justify-end gap-3">
                                <button
                                    onClick={closeClassificationModal}
                                    className="px-4 py-2 text-sm bg-white border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-100"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={handleSaveClassification}
                                    disabled={isSavingClassification}
                                    className={`px-4 py-2 text-sm text-white rounded-lg ${isSavingClassification ? 'bg-indigo-300' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                                >
                                    {isSavingClassification ? 'Guardandoâ€¦' : 'Guardar'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {traceabilityExpense && (
                    <div className="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50">
                        <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div className="flex items-start justify-between px-6 py-4 border-b border-gray-200">
                                <div>
                                    {(() => {
                                        const config = getTaxSourceConfig(traceabilityExpense.tax_source);
                                        return (
                                            <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                                <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${config.badgeClass}`}>
                                                    <i className={`fas ${config.icon} mr-1`}></i>
                                                    {config.label}
                                                </span>
                                                Trazabilidad fiscal de {traceabilityExpense.descripcion || 'Gasto'}
                                            </h3>
                                        );
                                    })()}
                                    <p className="text-sm text-gray-500">Proveedor: {traceabilityExpense.merchant_name || traceabilityExpense.proveedor || 'Sin proveedor'} Â· Fecha: {traceabilityExpense.fecha_gasto || traceabilityExpense.fecha || 'â€”'}</p>
                                </div>
                                <button onClick={() => setTraceabilityExpense(null)} className="text-gray-400 hover:text-gray-600">
                                    <i className="fas fa-times text-lg"></i>
                                </button>
                            </div>

                            <div className="px-6 py-4 space-y-6">
                                <section className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-slate-100 border border-slate-200 rounded-lg p-4">
                                        <h4 className="text-sm font-semibold text-slate-800 mb-2">ClasificaciÃ³n fiscal</h4>
                                        <ul className="space-y-1 text-sm text-slate-700">
                                            <li><strong>Fuente:</strong> {traceabilityExpense.tax_source || 'â€”'} Â· {traceabilityExpense.classification_source || 'â€”'}</li>
                                            <li><strong>ExplicaciÃ³n:</strong> {traceabilityExpense.explanation_short || 'â€”'}</li>
                                            {traceabilityExpense.explanation_detail && <li className="text-xs text-slate-500 leading-snug">{traceabilityExpense.explanation_detail}</li>}
                                            <li><strong>CatÃ¡logo:</strong> {traceabilityExpense.catalog_version || 'v1'}</li>
                                            <li><strong>Confianza:</strong> {typeof traceabilityExpense.categoria_confianza === 'number' ? `${Math.round(traceabilityExpense.categoria_confianza * 100)}%` : 'N/D'}</li>
                                            <li><strong>CÃ³digos SAT:</strong> {traceabilityExpense.sat_account_code || 'â€”'} / {traceabilityExpense.sat_product_service_code || 'â€”'}</li>
                                        </ul>
                                        <a href="/docs/fiscal_pipeline.md" target="_blank" rel="noopener" className="mt-3 inline-flex items-center text-xs text-blue-600 hover:underline">
                                            <i className="fas fa-book mr-1"></i>
                                            Ver guÃ­a fiscal
                                        </a>
                                    </div>
                                    <div className="bg-slate-100 border border-slate-200 rounded-lg p-4">
                                        <h4 className="text-sm font-semibold text-slate-800 mb-2">CFDI y pÃ³liza</h4>
                                        <ul className="space-y-1 text-sm text-slate-700">
                                            <li><strong>CFDI status:</strong> {traceabilityExpense.cfdi_status || 'â€”'}</li>
                                            <li><strong>CFDI UUID:</strong> {traceabilityExpense.cfdi_uuid || 'â€”'}</li>
                                            <li><strong>PÃ³liza contable:</strong> {traceabilityExpense.asientos_contables?.numero_poliza || 'â€”'}</li>
                                            <li><strong>Estado factura:</strong> {traceabilityExpense.invoice_status || 'â€”'}</li>
                                            <li><strong>IVA acreditable:</strong> {(traceabilityExpense.iva_16 || traceabilityExpense.iva_8 || traceabilityExpense.iva_0)
                                                ? `$${Number((traceabilityExpense.iva_16 || 0) + (traceabilityExpense.iva_8 || 0) + (traceabilityExpense.iva_0 || 0)).toLocaleString('es-MX', { minimumFractionDigits: 2 })}`
                                                : 'â€”'}</li>
                                        </ul>
                                        <div className="flex gap-3 mt-2">
                                            {traceabilityExpense.cfdi_pdf_url && (
                                                <a href={traceabilityExpense.cfdi_pdf_url} target="_blank" rel="noopener" className="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                                    <i className="fas fa-file-pdf"></i> PDF
                                                </a>
                                            )}
                                            {traceabilityExpense.cfdi_xml_url && (
                                                <a href={traceabilityExpense.cfdi_xml_url} target="_blank" rel="noopener" className="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                                    <i className="fas fa-file-code"></i> XML
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                </section>

                                <section className="bg-slate-100 border border-slate-200 rounded-lg p-4">
                                    <h4 className="text-sm font-semibold text-slate-800 mb-2">Bancario</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm text-slate-700">
                                        <div>
                                            <strong>Estado banco:</strong>
                                            <p>{traceabilityExpense.bank_status_meta?.label || traceabilityExpense.bank_status || 'â€”'}</p>
                                        </div>
                                        <div>
                                            <strong>ConciliaciÃ³n:</strong>
                                            <p>{traceabilityExpense.estado_conciliacion || 'â€”'}</p>
                                        </div>
                                        <div>
                                            <strong>Movimientos vinculados:</strong>
                                            <p>{Array.isArray(traceabilityExpense.movimientos_bancarios) ? traceabilityExpense.movimientos_bancarios.length : 0}</p>
                                        </div>
                                    </div>
                                    {Array.isArray(traceabilityExpense.movimientos_bancarios) && traceabilityExpense.movimientos_bancarios.length > 0 && (
                                        <ul className="mt-3 space-y-1 text-xs text-slate-600">
                                            {traceabilityExpense.movimientos_bancarios.slice(0, 5).map((mov) => (
                                                <li key={mov.id || mov.reference} className="flex items-center gap-2">
                                                    <i className="fas fa-exchange-alt text-slate-400"></i>
                                                    <span>{mov.description || mov.descripcion || 'Movimiento bancario'} Â· ${Number(mov.amount || mov.monto).toLocaleString('es-MX', { minimumFractionDigits: 2 })}</span>
                                                </li>
                                            ))}
                                            {traceabilityExpense.movimientos_bancarios.length > 5 && (
                                                <li className="text-amber-600">+{traceabilityExpense.movimientos_bancarios.length - 5} movimientos adicionales</li>
                                            )}
                                        </ul>
                                    )}
                                </section>
                            </div>

                            <div className="px-6 py-4 bg-slate-100 border-t border-slate-200 flex justify-end">
                                <button onClick={() => setTraceabilityExpense(null)} className="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">Cerrar</button>
                            </div>
                        </div>
                    </div>
                )}
                </>
            );
        };

        ReactDOM.render(<ExpensesViewerEnhanced />, document.getElementById('root'));
    </script>
</body>
</html>
