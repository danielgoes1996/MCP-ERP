<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Datos Fiscales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto py-8 px-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-file-invoice text-blue-600 mr-2"></i>
                        Configuración de Datos Fiscales
                    </h1>
                    <p class="text-gray-600 mt-1">Configura tu información fiscal para facturación automática</p>
                </div>
                <button onclick="window.location.href='/invoicing/simple'"
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    <i class="fas fa-arrow-left mr-2"></i>Volver
                </button>
            </div>
        </div>

        <!-- Opciones de Carga -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Opción 1: Cargar CSF -->
            <div class="bg-white rounded-lg shadow p-6 border-2 border-transparent hover:border-blue-500 transition cursor-pointer"
                 onclick="showCSFUpload()">
                <div class="text-center">
                    <div class="text-4xl text-blue-600 mb-4">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Cargar Constancia de Situación Fiscal</h3>
                    <p class="text-gray-600 text-sm">
                        Carga tu CSF en PDF y extraeremos automáticamente tu información fiscal
                    </p>
                    <button class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        <i class="fas fa-upload mr-2"></i>Cargar CSF
                    </button>
                </div>
            </div>

            <!-- Opción 2: Captura Manual -->
            <div class="bg-white rounded-lg shadow p-6 border-2 border-transparent hover:border-green-500 transition cursor-pointer"
                 onclick="showManualForm()">
                <div class="text-center">
                    <div class="text-4xl text-green-600 mb-4">
                        <i class="fas fa-keyboard"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Captura Manual</h3>
                    <p class="text-gray-600 text-sm">
                        Ingresa manualmente tu información fiscal
                    </p>
                    <button class="mt-4 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                        <i class="fas fa-edit mr-2"></i>Capturar Datos
                    </button>
                </div>
            </div>
        </div>

        <!-- Formulario CSF (hidden by default) -->
        <div id="csf-upload" class="bg-white rounded-lg shadow p-6 mb-6" style="display: none;">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-file-pdf text-blue-600 mr-2"></i>
                Cargar Constancia de Situación Fiscal
            </h3>
            <form onsubmit="uploadCSF(event)">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <input type="file" id="csf-file" accept=".pdf" class="hidden" onchange="handleCSFFile(event)">
                    <label for="csf-file" class="cursor-pointer">
                        <div class="text-gray-400">
                            <i class="fas fa-cloud-upload-alt text-5xl mb-4"></i>
                            <p class="text-lg">Arrastra tu CSF aquí o haz clic para seleccionar</p>
                            <p class="text-sm mt-2">Solo archivos PDF (máx. 10MB)</p>
                        </div>
                    </label>
                    <div id="csf-preview" class="mt-4 hidden">
                        <p class="text-green-600 font-medium">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span id="csf-filename"></span>
                        </p>
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button type="button" onclick="hideAllForms()"
                            class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        <i class="fas fa-magic mr-2"></i>Extraer Datos
                    </button>
                </div>
            </form>
        </div>

        <!-- Formulario Manual (hidden by default) -->
        <div id="manual-form" class="bg-white rounded-lg shadow p-6" style="display: none;">
            <h3 class="text-lg font-bold mb-6">
                <i class="fas fa-edit text-green-600 mr-2"></i>
                Captura Manual de Datos Fiscales
            </h3>
            <form onsubmit="saveFiscalData(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- RFC -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            RFC <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="rfc" name="rfc" required
                               pattern="[A-Z&Ñ]{3,4}[0-9]{6}[A-Z0-9]{3}"
                               placeholder="XAXX010101000"
                               class="w-full border border-gray-300 rounded px-3 py-2 uppercase"
                               oninput="this.value = this.value.toUpperCase()">
                        <p class="text-xs text-gray-500 mt-1">12 caracteres para persona moral, 13 para física</p>
                    </div>

                    <!-- Nombre/Razón Social -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Nombre o Razón Social <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="nombre" name="nombre" required
                               placeholder="Mi Empresa SA de CV"
                               class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>

                    <!-- Régimen Fiscal -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Régimen Fiscal <span class="text-red-500">*</span>
                        </label>
                        <select id="regimen" name="regimen" required
                                class="w-full border border-gray-300 rounded px-3 py-2">
                            <option value="">Seleccionar...</option>
                            <option value="601">601 - General de Ley Personas Morales</option>
                            <option value="603">603 - Personas Morales con Fines no Lucrativos</option>
                            <option value="605">605 - Sueldos y Salarios</option>
                            <option value="606">606 - Arrendamiento</option>
                            <option value="608">608 - Demás ingresos</option>
                            <option value="612">612 - Personas Físicas con Actividades Empresariales</option>
                            <option value="621">621 - Incorporación Fiscal</option>
                            <option value="626">626 - Régimen Simplificado de Confianza (RESICO)</option>
                        </select>
                    </div>

                    <!-- Código Postal -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Código Postal <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="codigo_postal" name="codigo_postal" required
                               pattern="[0-9]{5}"
                               placeholder="01000"
                               maxlength="5"
                               class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>

                    <!-- Estado -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Estado <span class="text-red-500">*</span>
                        </label>
                        <select id="estado" name="estado" required
                                class="w-full border border-gray-300 rounded px-3 py-2">
                            <option value="">Seleccionar...</option>
                            <option value="Aguascalientes">Aguascalientes</option>
                            <option value="Baja California">Baja California</option>
                            <option value="Baja California Sur">Baja California Sur</option>
                            <option value="Campeche">Campeche</option>
                            <option value="Chiapas">Chiapas</option>
                            <option value="Chihuahua">Chihuahua</option>
                            <option value="Ciudad de México">Ciudad de México</option>
                            <option value="Coahuila">Coahuila</option>
                            <option value="Colima">Colima</option>
                            <option value="Durango">Durango</option>
                            <option value="Estado de México">Estado de México</option>
                            <option value="Guanajuato">Guanajuato</option>
                            <option value="Guerrero">Guerrero</option>
                            <option value="Hidalgo">Hidalgo</option>
                            <option value="Jalisco">Jalisco</option>
                            <option value="Michoacán">Michoacán</option>
                            <option value="Morelos">Morelos</option>
                            <option value="Nayarit">Nayarit</option>
                            <option value="Nuevo León">Nuevo León</option>
                            <option value="Oaxaca">Oaxaca</option>
                            <option value="Puebla">Puebla</option>
                            <option value="Querétaro">Querétaro</option>
                            <option value="Quintana Roo">Quintana Roo</option>
                            <option value="San Luis Potosí">San Luis Potosí</option>
                            <option value="Sinaloa">Sinaloa</option>
                            <option value="Sonora">Sonora</option>
                            <option value="Tabasco">Tabasco</option>
                            <option value="Tamaulipas">Tamaulipas</option>
                            <option value="Tlaxcala">Tlaxcala</option>
                            <option value="Veracruz">Veracruz</option>
                            <option value="Yucatán">Yucatán</option>
                            <option value="Zacatecas">Zacatecas</option>
                        </select>
                    </div>

                    <!-- Ciudad/Municipio -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ciudad/Municipio <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="municipio" name="municipio" required
                               placeholder="Benito Juárez"
                               class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Email para Facturación
                        </label>
                        <input type="email" id="email" name="email"
                               placeholder="facturacion@empresa.com"
                               class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>

                    <!-- Teléfono -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Teléfono
                        </label>
                        <input type="tel" id="telefono" name="telefono"
                               placeholder="5555555555"
                               class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>

                    <!-- Dirección Completa -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Dirección Completa
                        </label>
                        <input type="text" id="direccion" name="direccion"
                               placeholder="Av. Insurgentes Sur 1234, Col. Del Valle"
                               class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>

                    <!-- Uso CFDI Default -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Uso de CFDI por Defecto
                        </label>
                        <select id="uso_cfdi" name="uso_cfdi"
                                class="w-full border border-gray-300 rounded px-3 py-2">
                            <option value="G03" selected>G03 - Gastos en general</option>
                            <option value="G01">G01 - Adquisición de mercancías</option>
                            <option value="G02">G02 - Devoluciones, descuentos o bonificaciones</option>
                            <option value="I01">I01 - Construcciones</option>
                            <option value="I02">I02 - Mobiliario y equipo de oficina</option>
                            <option value="I03">I03 - Equipo de transporte</option>
                            <option value="I04">I04 - Equipo de cómputo y accesorios</option>
                            <option value="I08">I08 - Otra maquinaria y equipo</option>
                            <option value="P01">P01 - Por definir</option>
                        </select>
                    </div>
                </div>

                <!-- Botones -->
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="hideAllForms()"
                            class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                        <i class="fas fa-save mr-2"></i>Guardar Datos Fiscales
                    </button>
                </div>
            </form>
        </div>

        <!-- Datos Fiscales Guardados -->
        <div id="saved-data" class="bg-green-50 border border-green-200 rounded-lg p-6" style="display: none;">
            <h3 class="text-lg font-bold text-green-800 mb-4">
                <i class="fas fa-check-circle mr-2"></i>Datos Fiscales Configurados
            </h3>
            <div id="fiscal-data-display" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Se llena dinámicamente -->
            </div>
            <div class="mt-4 flex space-x-3">
                <button onclick="editFiscalData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    <i class="fas fa-edit mr-2"></i>Editar
                </button>
                <button onclick="window.location.href='/invoicing/simple'"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    <i class="fas fa-arrow-right mr-2"></i>Ir a Facturación
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentFiscalData = null;

        function showCSFUpload() {
            hideAllForms();
            document.getElementById('csf-upload').style.display = 'block';
        }

        function showManualForm() {
            hideAllForms();
            document.getElementById('manual-form').style.display = 'block';
        }

        function hideAllForms() {
            document.getElementById('csf-upload').style.display = 'none';
            document.getElementById('manual-form').style.display = 'none';
        }

        function handleCSFFile(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                document.getElementById('csf-preview').classList.remove('hidden');
                document.getElementById('csf-filename').textContent = file.name;
            }
        }

        async function uploadCSF(event) {
            event.preventDefault();
            const fileInput = document.getElementById('csf-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Por favor selecciona un archivo PDF');
                return;
            }

            const formData = new FormData();
            formData.append('csf_file', file);

            try {
                const response = await fetch('/invoicing/fiscal-data/extract-csf', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentFiscalData = result.data;
                    displayFiscalData(result.data);
                    alert('Datos fiscales extraídos exitosamente');
                } else {
                    alert('Error extrayendo datos: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error procesando el archivo');
            }
        }

        async function saveFiscalData(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/invoicing/fiscal-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    currentFiscalData = result.data;
                    displayFiscalData(result.data);
                    alert('Datos fiscales guardados exitosamente');
                } else {
                    alert('Error guardando datos: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error guardando los datos');
            }
        }

        function displayFiscalData(data) {
            hideAllForms();
            const display = document.getElementById('fiscal-data-display');
            display.innerHTML = `
                <div><strong>RFC:</strong> ${data.rfc}</div>
                <div><strong>Nombre:</strong> ${data.nombre}</div>
                <div><strong>Régimen:</strong> ${data.regimen_fiscal?.descripcion || data.regimen}</div>
                <div><strong>C.P.:</strong> ${data.codigo_postal}</div>
                <div><strong>Estado:</strong> ${data.estado}</div>
                <div><strong>Ciudad:</strong> ${data.municipio}</div>
                ${data.email ? `<div><strong>Email:</strong> ${data.email}</div>` : ''}
                ${data.telefono ? `<div><strong>Teléfono:</strong> ${data.telefono}</div>` : ''}
                ${data.direccion ? `<div class="md:col-span-2"><strong>Dirección:</strong> ${data.direccion}</div>` : ''}
            `;
            document.getElementById('saved-data').style.display = 'block';
        }

        function editFiscalData() {
            if (currentFiscalData) {
                // Llenar formulario con datos actuales
                document.getElementById('rfc').value = currentFiscalData.rfc;
                document.getElementById('nombre').value = currentFiscalData.nombre;
                document.getElementById('regimen').value = currentFiscalData.regimen_fiscal?.clave || '';
                document.getElementById('codigo_postal').value = currentFiscalData.codigo_postal;
                document.getElementById('estado').value = currentFiscalData.estado;
                document.getElementById('municipio').value = currentFiscalData.municipio;
                document.getElementById('email').value = currentFiscalData.email || '';
                document.getElementById('telefono').value = currentFiscalData.telefono || '';
                document.getElementById('direccion').value = currentFiscalData.direccion || '';
            }
            document.getElementById('saved-data').style.display = 'none';
            showManualForm();
        }

        // Cargar datos fiscales guardados al iniciar
        async function loadSavedFiscalData() {
            try {
                const response = await fetch('/invoicing/fiscal-data');
                const result = await response.json();
                if (result.success && result.data) {
                    currentFiscalData = result.data;
                    displayFiscalData(result.data);
                }
            } catch (error) {
                console.error('Error cargando datos fiscales:', error);
            }
        }

        // Cargar al iniciar
        loadSavedFiscalData();
    </script>
</body>
</html>