"use strict";function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}var _process;function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){_defineProperty(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==_typeof(i)?i:i+""}function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function _regenerator(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function i(r,n,o,i){var c=n&&n.prototype instanceof Generator?n:Generator,u=Object.create(c.prototype);return _regeneratorDefine2(u,"_invoke",function(r,n,o){var i,c,u,f=0,p=o||[],y=!1,G={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function d(t,r){return i=t,c=0,u=e,G.n=r,a}};function d(r,n){for(c=r,u=n,t=0;!y&&f&&!o&&t<p.length;t++){var o,i=p[t],d=G.p,l=i[2];r>3?(o=l===n)&&(u=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=e):i[0]<=d&&((o=r<2&&d<i[1])?(c=0,G.v=n,G.n=i[1]):d<l&&(o=r<3||i[0]>n||n>l)&&(i[4]=r,i[5]=n,G.n=l,c=0))}if(o||r>1)return a;throw y=!0,n}return function(o,p,l){if(f>1)throw TypeError("Generator is already running");for(y&&1===p&&d(p,l),c=p,u=l;(t=c<2?e:u)||!y;){i||(c?c<3?(c>1&&(G.n=-1),d(c,u)):G.n=u:G.v=u);try{if(f=2,i){if(c||(o="next"),t=i[o]){if(!(t=t.call(i,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=i["return"])&&t.call(i),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=e}else if((t=(y=G.n<0)?u:r.call(n,G))!==a)break}catch(t){i=e,c=1,u=t}finally{f=1}}return{value:t,done:y}}}(r,o,i),!0),u}var a={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}t=Object.getPrototypeOf;var c=[][n]?t(t([][n]())):(_regeneratorDefine2(t={},n,function(){return this}),t),u=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(c);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,_regeneratorDefine2(e,o,"GeneratorFunction")),e.prototype=Object.create(u),e}return GeneratorFunction.prototype=GeneratorFunctionPrototype,_regeneratorDefine2(u,"constructor",GeneratorFunctionPrototype),_regeneratorDefine2(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName="GeneratorFunction",_regeneratorDefine2(GeneratorFunctionPrototype,o,"GeneratorFunction"),_regeneratorDefine2(u),_regeneratorDefine2(u,o,"Generator"),_regeneratorDefine2(u,n,function(){return this}),_regeneratorDefine2(u,"toString",function(){return"[object Generator]"}),(_regenerator=function _regenerator(){return{w:i,m:f}})()}function _regeneratorDefine2(e,r,n,t){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}_regeneratorDefine2=function _regeneratorDefine(e,r,n,t){function o(r,n){_regeneratorDefine2(e,r,function(e){return this._invoke(r,n,e)})}r?i?i(e,r,{value:n,enumerable:!t,configurable:!t,writable:!t}):e[r]=n:(o("next",0),o("throw",1),o("return",2))},_regeneratorDefine2(e,r,n,t)}function _toConsumableArray(r){return _arrayWithoutHoles(r)||_iterableToArray(r)||_unsupportedIterableToArray(r)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(r){if("undefined"!=typeof Symbol&&null!=r[Symbol.iterator]||null!=r["@@iterator"])return Array.from(r)}function _arrayWithoutHoles(r){if(Array.isArray(r))return _arrayLikeToArray(r)}function _createForOfIteratorHelper(r,e){var t="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&"number"==typeof r.length){t&&(r=t);var _n=0,F=function F(){};return{s:F,n:function n(){return _n>=r.length?{done:!0}:{done:!1,value:r[_n++]}},e:function e(r){throw r},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function s(){t=t.call(r)},n:function n(){var r=t.next();return a=r.done,r},e:function e(r){u=!0,o=r},f:function f(){try{a||null==t["return"]||t["return"]()}finally{if(u)throw o}}}}function asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise(function(r,o){var a=n.apply(t,e);function _next(n){asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)})}}function _slicedToArray(r,e){return _arrayWithHoles(r)||_iterableToArrayLimit(r,e)||_unsupportedIterableToArray(r,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t["return"]&&(u=t["return"](),Object(u)!==u))return}finally{if(o)throw n}}return a}}function _arrayWithHoles(r){if(Array.isArray(r))return r}var _React=React,useState=_React.useState,useEffect=_React.useEffect,useMemo=_React.useMemo,useCallback=_React.useCallback;var __DEV__=typeof process!=="undefined"&&((_process=process)===null||_process===void 0?void 0:_process.env)&&process.env.NODE_ENV!=="production";var toNumber=function toNumber(value){var fallback=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(value===null||value===undefined)return fallback;var numeric=Number(value);return Number.isFinite(numeric)?numeric:fallback};var readConfidence=function readConfidence(movement){var _ref,_ref2,_movement$matching_co;var raw=(_ref=(_ref2=(_movement$matching_co=movement===null||movement===void 0?void 0:movement.matching_confidence)!==null&&_movement$matching_co!==void 0?_movement$matching_co:movement===null||movement===void 0?void 0:movement.confidence_score)!==null&&_ref2!==void 0?_ref2:movement===null||movement===void 0?void 0:movement.auto_match_confidence)!==null&&_ref!==void 0?_ref:movement===null||movement===void 0?void 0:movement.confidence;if(raw===null||raw===undefined)return 0;var value=typeof raw==="string"?parseFloat(raw):raw;if(!Number.isFinite(value))return 0;if(value>1){return Math.max(0,Math.min(1,value/100))}return Math.max(0,Math.min(1,value))};var isConciliated=function isConciliated(movement){var state=String((movement===null||movement===void 0?void 0:movement.state)||"").toLowerCase();if(state==="conciliado"){return true}var status=String((movement===null||movement===void 0?void 0:movement.processing_status)||(movement===null||movement===void 0?void 0:movement.conciliation_status)||(movement===null||movement===void 0?void 0:movement.status)||(movement===null||movement===void 0?void 0:movement.reconciliation_status)||"").toLowerCase();return["processed","conciliated","reconciled","conciliado","finalized","completed"].includes(status)};var hasCfdi=function hasCfdi(movement){var _movement$invoice;return Boolean((movement===null||movement===void 0?void 0:movement.cfdi_uuid)||(movement===null||movement===void 0?void 0:movement.matched_cfdi_uuid)||(movement===null||movement===void 0?void 0:movement.invoice_uuid)||(movement===null||movement===void 0?void 0:movement.matched_invoice_uuid)||(movement===null||movement===void 0||(_movement$invoice=movement.invoice)===null||_movement$invoice===void 0?void 0:_movement$invoice.uuid))};var isPPD=function isPPD(movement){var _movement$invoice2,_movement$metadata,_movement$metadata2;var paymentMethod=String((movement===null||movement===void 0?void 0:movement.payment_method)||(movement===null||movement===void 0||(_movement$invoice2=movement.invoice)===null||_movement$invoice2===void 0?void 0:_movement$invoice2.payment_method)||(movement===null||movement===void 0||(_movement$metadata=movement.metadata)===null||_movement$metadata===void 0?void 0:_movement$metadata.payment_method)||"").toUpperCase();if(paymentMethod.includes("PPD"))return true;var badges=(movement===null||movement===void 0?void 0:movement.badges)||(movement===null||movement===void 0||(_movement$metadata2=movement.metadata)===null||_movement$metadata2===void 0?void 0:_movement$metadata2.badges)||[];return badges.some(function(badge){return /PPD/i.test(badge.label||badge)})};var intlRegex=/(META ADS|FACEBOOK|GOOGLE|AWS|AMAZON\.COM|ADOBE|MICROSOFT|APPLE\.COM|SHOPIFY|STRIPE|PAYPAL|AIRBNB|UBER BV|UBER TRIP|META\s+PLATFORMS|SPOTIFY|OPENAI|CLOUDFLARE|DIGITALOCEAN|ATLASSIAN|FIVERR|UPWORK)/i;var isIntlWithoutCfdi=function isIntlWithoutCfdi(movement){if(hasCfdi(movement))return false;var currency=String((movement===null||movement===void 0?void 0:movement.currency)||(movement===null||movement===void 0?void 0:movement.moneda)||"").toUpperCase();if(currency&&currency!=="MXN")return true;var description=String((movement===null||movement===void 0?void 0:movement.description)||(movement===null||movement===void 0?void 0:movement.descripcion)||"").toUpperCase();if(intlRegex.test(description))return true;var badges=(movement===null||movement===void 0?void 0:movement.badges)||[];return badges.some(function(badge){return /INTL|Internacional/i.test(badge.label||badge)})};var incomeHints=/(dep[oó]sito|abono|pago recibido|transferencia recibida|venta|ingreso|mercadopago|clip|stripe payout|paypal payout)/i;var expenseHints=/(comisi[oó]n|pago|servicio|compra|cargo|retiro|spei a|transferencia a|traspaso a)/i;var classifyFlow=function classifyFlow(movement){var _movement$amount;var flow=String((movement===null||movement===void 0?void 0:movement.flow)||(movement===null||movement===void 0?void 0:movement.movement_flow)||(movement===null||movement===void 0?void 0:movement.tipo_movimiento)||"").toLowerCase();if(flow==="ingreso"||flow==="egreso")return flow;var amount=toNumber((_movement$amount=movement===null||movement===void 0?void 0:movement.amount)!==null&&_movement$amount!==void 0?_movement$amount:movement===null||movement===void 0?void 0:movement.monto,0);if(amount>0&&flow.includes("ing"))return"ingreso";if(amount<0&&flow.includes("egr"))return"egreso";var description=String((movement===null||movement===void 0?void 0:movement.description)||(movement===null||movement===void 0?void 0:movement.descripcion)||"").toLowerCase();if(incomeHints.test(description))return"ingreso";if(expenseHints.test(description))return"egreso";return amount>=0?"ingreso":"egreso"};var computePPDInfo=function computePPDInfo(row){var _row$invoice,_row$ppd;var total=toNumber(row===null||row===void 0||(_row$invoice=row.invoice)===null||_row$invoice===void 0?void 0:_row$invoice.total,0);var complements=Array.isArray(row===null||row===void 0||(_row$ppd=row.ppd)===null||_row$ppd===void 0?void 0:_row$ppd.complementos)?row.ppd.complementos:[];var paid=complements.reduce(function(sum,item){return sum+toNumber(item.amountPaid||item.importe_pagado||item.monto_pagado,0)},0);var percent=total>0?Math.min(100,Math.round(paid/total*100)):0;var remaining=Math.max(0,total-paid);var currentPaymentPercent=total>0?Math.round(toNumber(row.amount,0)/total*100):0;return{total:total,complements:complements,paid:paid,percent:percent,nextParcialidad:complements.length+1,remaining:remaining,currentPaymentPercent:currentPaymentPercent}};var formatCurrency=function formatCurrency(value){var currency=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"MXN";var numeric=toNumber(value,0);return new Intl.NumberFormat("es-MX",{style:"currency",currency:currency}).format(numeric)};var formatDate=function formatDate(value){if(!value)return"\u2014";try{return new Date(value).toLocaleDateString("es-MX")}catch(error){return value}};var formatPeriodLabel=function formatPeriodLabel(period){if(!period)return"Sin periodo";var date=new Date("".concat(period,"-01T00:00:00"));if(Number.isNaN(date.getTime()))return period;return date.toLocaleDateString("es-MX",{month:"long",year:"numeric"})};var normalizeToKey=function normalizeToKey(value){if(!value||typeof value!=="string")return null;var working=value.trim().toLowerCase();if(!working)return null;try{working=working.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}catch(error){}var sanitized=working.replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");return sanitized||null};var resolveAccountMetadata=function resolveAccountMetadata(movement){var _movement$metadata3,_movement$metadata4,_movement$metadata5,_movement$metadata6,_movement$metadata7,_movement$metadata8,_movement$metadata9,_movement$metadata0,_movement$metadata1,_labelCandidates$find;var idCandidates=[movement===null||movement===void 0?void 0:movement.bank_account_id,movement===null||movement===void 0||(_movement$metadata3=movement.metadata)===null||_movement$metadata3===void 0?void 0:_movement$metadata3.payment_account_id,movement===null||movement===void 0?void 0:movement.account_id,movement===null||movement===void 0?void 0:movement.account,movement===null||movement===void 0||(_movement$metadata4=movement.metadata)===null||_movement$metadata4===void 0?void 0:_movement$metadata4.account_id,movement===null||movement===void 0||(_movement$metadata5=movement.metadata)===null||_movement$metadata5===void 0?void 0:_movement$metadata5.account_number,movement===null||movement===void 0||(_movement$metadata6=movement.metadata)===null||_movement$metadata6===void 0?void 0:_movement$metadata6.account_identifier,movement===null||movement===void 0||(_movement$metadata7=movement.metadata)===null||_movement$metadata7===void 0?void 0:_movement$metadata7.clabe];var accountId=null;for(var _i=0,_idCandidates=idCandidates;_i<_idCandidates.length;_i++){var candidate=_idCandidates[_i];if(candidate===null||candidate===undefined)continue;var value=String(candidate).trim();if(value){accountId=value;break}}var labelCandidates=[movement===null||movement===void 0||(_movement$metadata8=movement.metadata)===null||_movement$metadata8===void 0?void 0:_movement$metadata8.account_label,movement===null||movement===void 0?void 0:movement.account_label,movement===null||movement===void 0||(_movement$metadata9=movement.metadata)===null||_movement$metadata9===void 0?void 0:_movement$metadata9.account_name,movement===null||movement===void 0||(_movement$metadata0=movement.metadata)===null||_movement$metadata0===void 0?void 0:_movement$metadata0.bank_name,movement===null||movement===void 0||(_movement$metadata1=movement.metadata)===null||_movement$metadata1===void 0?void 0:_movement$metadata1.bank,movement===null||movement===void 0?void 0:movement.bank,movement===null||movement===void 0?void 0:movement.display_name];var label=((_labelCandidates$find=labelCandidates.find(function(candidate){return typeof candidate==="string"&&candidate.trim()}))===null||_labelCandidates$find===void 0?void 0:_labelCandidates$find.trim())||null;if(!accountId){var normalized=label?normalizeToKey(label):null;accountId=normalized?"label:".concat(normalized):"sin-cuenta"}var accountLabel=label||(!accountId.startsWith("label:")&&accountId!=="sin-cuenta"?"Cuenta ".concat(accountId):"Cuenta sin etiqueta");return{accountId:accountId,accountLabel:accountLabel}};var getActiveCompanyId=function getActiveCompanyId(){try{var stored=localStorage.getItem("mcp_company_id");if(stored&&stored.trim()){return stored}}catch(error){console.warn("No se pudo leer mcp_company_id de localStorage:",error)}return"default"};var showToast=function showToast(message){var _window,_window2;var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"info";if((_window=window)!==null&&_window!==void 0&&(_window=_window.mcpHeader)!==null&&_window!==void 0&&_window.showNotification){window.mcpHeader.showNotification(message,type);return}if((_window2=window)!==null&&_window2!==void 0&&(_window2=_window2.Toast)!==null&&_window2!==void 0&&_window2.show){var intentMap={success:"success",warning:"warning",error:"danger",info:"info"};window.Toast.show({message:message,intent:intentMap[type]||"info"});return}console.log("[toast:".concat(type,"]"),message)};var mapSuggestion=function mapSuggestion(suggestion){var _ref3,_ref4,_suggestion$score;if(!suggestion)return null;var scoreRaw=(_ref3=(_ref4=(_suggestion$score=suggestion.score)!==null&&_suggestion$score!==void 0?_suggestion$score:suggestion.confidence)!==null&&_ref4!==void 0?_ref4:suggestion.match_confidence)!==null&&_ref3!==void 0?_ref3:suggestion.similarity;var scoreNormalized=Number.isFinite(scoreRaw)?scoreRaw>1?scoreRaw:scoreRaw*100:0;return{title:suggestion.title||suggestion.label||suggestion.uuid||"Sugerencia",score:Math.round(scoreNormalized),detail:suggestion.detail||suggestion.description||suggestion.reason||"",raw:suggestion}};var mapInvoice=function mapInvoice(movement){var _invoice$subtotal,_ref5,_taxes$iva,_taxes$ieps,_ref6,_taxes$retenciones;var invoice=(movement===null||movement===void 0?void 0:movement.invoice)||(movement===null||movement===void 0?void 0:movement.matched_invoice)||(movement===null||movement===void 0?void 0:movement.cfdi_details)||null;if(!invoice)return null;var taxes=invoice.taxes||invoice.impuestos||{};return{uuid:invoice.uuid||invoice.timbre_fiscal_uuid||invoice.cfdi_uuid||null,supplierName:invoice.supplierName||invoice.razon_social||invoice.proveedor||invoice.emisor||null,subtotal:toNumber((_invoice$subtotal=invoice.subtotal)!==null&&_invoice$subtotal!==void 0?_invoice$subtotal:taxes.subtotal,0),total:toNumber(invoice.total,0),paymentMethod:invoice.paymentMethod||invoice.forma_pago||invoice.metodo_pago||null,taxes:{iva:toNumber((_ref5=(_taxes$iva=taxes.iva)!==null&&_taxes$iva!==void 0?_taxes$iva:taxes.iva_16)!==null&&_ref5!==void 0?_ref5:taxes.impuesto_iva,0),ieps:toNumber((_taxes$ieps=taxes.ieps)!==null&&_taxes$ieps!==void 0?_taxes$ieps:taxes.impuesto_ieps,0),retenciones:toNumber((_ref6=(_taxes$retenciones=taxes.retenciones)!==null&&_taxes$retenciones!==void 0?_taxes$retenciones:taxes.isr)!==null&&_ref6!==void 0?_ref6:taxes.retenciones_isr,0)}}};var detectBadges=function detectBadges(movement,flow){var _movement$metadata10;var badges=[];if(isConciliated(movement)){badges.push({label:"Conciliado",tone:"success"})}if(!hasCfdi(movement)){badges.push({label:"Sin CFDI",tone:"danger"})}else{badges.push({label:"CFDI",tone:"info"})}if(flow==="ingreso"){badges.push({label:"Ingreso",tone:"success"})}else if(flow==="egreso"){badges.push({label:"Egreso",tone:"danger"})}if(isPPD(movement)){badges.push({label:"PPD",tone:"warning"})}if(isIntlWithoutCfdi(movement)){badges.push({label:"Internacional",tone:"info"})}var tags=(movement===null||movement===void 0?void 0:movement.badges)||(movement===null||movement===void 0?void 0:movement.tags)||(movement===null||movement===void 0||(_movement$metadata10=movement.metadata)===null||_movement$metadata10===void 0?void 0:_movement$metadata10.tags)||[];tags.forEach(function(tag){var label=(tag===null||tag===void 0?void 0:tag.label)||tag;if(!label)return;if(/propias|transferencia interna/i.test(label)){badges.push({label:"Propias",tone:"success"})}if(/comision|comisión/i.test(label)){badges.push({label:"Comisi\xF3n",tone:"info"})}});return badges};var mapMovementToRow=function mapMovementToRow(movement){var _movement$amount2,_suggestions$;var id=(movement===null||movement===void 0?void 0:movement.movement_id)||(movement===null||movement===void 0?void 0:movement.id)||(movement===null||movement===void 0?void 0:movement.uuid)||(movement===null||movement===void 0?void 0:movement.transaction_id)||"mov-".concat(Math.random().toString(36).slice(2));var amount=toNumber((_movement$amount2=movement===null||movement===void 0?void 0:movement.amount)!==null&&_movement$amount2!==void 0?_movement$amount2:movement===null||movement===void 0?void 0:movement.monto,0);var currency=String((movement===null||movement===void 0?void 0:movement.currency)||(movement===null||movement===void 0?void 0:movement.moneda)||"MXN").toUpperCase();var date=(movement===null||movement===void 0?void 0:movement.movement_date)||(movement===null||movement===void 0?void 0:movement.fecha)||(movement===null||movement===void 0?void 0:movement.date)||(movement===null||movement===void 0?void 0:movement.fecha_movimiento)||null;var description=(movement===null||movement===void 0?void 0:movement.bank_description)||(movement===null||movement===void 0?void 0:movement.description)||(movement===null||movement===void 0?void 0:movement.descripcion)||"Movimiento bancario";var suggestionText=(movement===null||movement===void 0?void 0:movement.suggestion)||(movement===null||movement===void 0?void 0:movement.ai_summary)||(movement===null||movement===void 0?void 0:movement.best_match_description)||(movement===null||movement===void 0?void 0:movement.matched_expense_description)||"";var flow=classifyFlow(movement);var confidence=readConfidence(movement);var rawSuggestions=(movement===null||movement===void 0?void 0:movement.ai_suggestions)||(movement===null||movement===void 0?void 0:movement.suggestions)||(movement===null||movement===void 0?void 0:movement.candidates)||[];var suggestions=rawSuggestions.map(mapSuggestion).filter(Boolean);if(movement!==null&&movement!==void 0&&movement.ai_top_match){var topMatch=mapSuggestion(movement.ai_top_match);if(topMatch)suggestions.unshift(topMatch)}var invoice=mapInvoice(movement);var ppd=(movement===null||movement===void 0?void 0:movement.ppd)||(movement===null||movement===void 0?void 0:movement.ppd_metadata)||null;var bankLongDescription=(movement===null||movement===void 0?void 0:movement.long_description)||(movement===null||movement===void 0?void 0:movement.descripcion_larga)||(movement===null||movement===void 0?void 0:movement.bank_long_description)||description;var state=String((movement===null||movement===void 0?void 0:movement.state)||"PENDIENTE").toUpperCase();var conciliated=state==="CONCILIADO";var _resolveAccountMetada=resolveAccountMetadata(movement),accountId=_resolveAccountMetada.accountId,accountLabel=_resolveAccountMetada.accountLabel;return{id:id,raw:movement,date:date,period:date?String(date).slice(0,7):null,description:description,bankLongDescription:bankLongDescription,amount:amount,currency:currency,accountId:accountId,accountLabel:accountLabel,suggestion:suggestionText||(suggestions===null||suggestions===void 0||(_suggestions$=suggestions[0])===null||_suggestions$===void 0?void 0:_suggestions$.title)||"",confidence:Math.round(confidence*100),badges:detectBadges(movement,flow),conciliated:conciliated,hasCfdi:hasCfdi(movement),flow:flow,invoice:invoice,ppd:ppd,suggestions:suggestions,metadata:(movement===null||movement===void 0?void 0:movement.metadata)||{},reconciliationStatus:(movement===null||movement===void 0?void 0:movement.reconciliation_status)||null,state:state,onGotoStatement:movement!==null&&movement!==void 0&&movement.goto_statement?function(){return movement.goto_statement(movement)}:movement===null||movement===void 0?void 0:movement.onGotoStatement}};var Badge=function Badge(_ref7){var children=_ref7.children,_ref7$tone=_ref7.tone,tone=_ref7$tone===void 0?"neutral":_ref7$tone;return React.createElement("span",{className:"inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium border ".concat(tone==="success"?"bg-emerald-50 text-emerald-700 border-emerald-200":tone==="warning"?"bg-amber-50 text-amber-700 border-amber-200":tone==="danger"?"bg-red-50 text-red-700 border-red-200":tone==="info"?"bg-blue-50 text-blue-700 border-blue-200":"bg-slate-50 text-slate-700 border-slate-200")},children)};var Kpi=function Kpi(_ref8){var label=_ref8.label,value=_ref8.value,hint=_ref8.hint,_ref8$tone=_ref8.tone,tone=_ref8$tone===void 0?"neutral":_ref8$tone;return React.createElement("div",{className:"flex flex-col gap-1 rounded-2xl p-4 border shadow-sm bg-white ".concat(tone==="success"?"border-emerald-200":tone==="danger"?"border-red-200":"border-slate-200")},React.createElement("div",{className:"text-slate-500 text-xs uppercase tracking-wide"},label),React.createElement("div",{className:"text-2xl font-semibold"},value),hint&&React.createElement("div",{className:"text-slate-400 text-xs"},hint))};var FlowFilter=function FlowFilter(_ref9){var value=_ref9.value,onChange=_ref9.onChange;return React.createElement("div",{className:"inline-flex items-center gap-1 border rounded-xl p-1 bg-white"},[{key:"all",label:"Todo"},{key:"ingreso",label:"Ingresos"},{key:"egreso",label:"Egresos"}].map(function(opt){return React.createElement("button",{key:opt.key,onClick:function onClick(){return onChange(opt.key)},className:"px-3 py-1.5 text-sm rounded-lg ".concat(value===opt.key?"bg-slate-900 text-white":"hover:bg-slate-50")},opt.label)}))};var StatusFilter=function StatusFilter(_ref0){var value=_ref0.value,onChange=_ref0.onChange;return React.createElement("div",{className:"inline-flex items-center gap-1 border rounded-xl p-1 bg-white"},[{key:"all",label:"Todos"},{key:"conciliated",label:"Conciliados"},{key:"pending",label:"Por conciliar"}].map(function(opt){return React.createElement("button",{key:opt.key,onClick:function onClick(){return onChange(opt.key)},className:"px-3 py-1.5 text-sm rounded-lg ".concat(value===opt.key?"bg-emerald-600 text-white":"hover:bg-slate-50")},opt.label)}))};var Toolbar=function Toolbar(_ref1){var flowFilter=_ref1.flowFilter,setFlowFilter=_ref1.setFlowFilter,onAutoConciliate=_ref1.onAutoConciliate,autoConciliating=_ref1.autoConciliating,onUploadMovements=_ref1.onUploadMovements,onOpenSatModal=_ref1.onOpenSatModal,onExport=_ref1.onExport;return React.createElement("div",{className:"flex flex-wrap items-center gap-2"},React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-slate-900 text-white px-3.5 py-2 text-sm shadow hover:bg-black disabled:opacity-60",onClick:onAutoConciliate,disabled:autoConciliating},React.createElement("i",{className:"fas fa-bolt w-4"}),autoConciliating?"Auto-conciliando\u2026":"Auto-Conciliar"),React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-white border px-3 py-2 text-sm hover:bg-slate-50",onClick:onUploadMovements},React.createElement("i",{className:"fas fa-upload w-4"})," Subir Movimientos"),React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-white border px-3 py-2 text-sm hover:bg-slate-50",onClick:onOpenSatModal},React.createElement("i",{className:"fas fa-file-import w-4"})," Importar CFDI SAT"),React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-white border px-3 py-2 text-sm hover:bg-slate-50",onClick:onExport},React.createElement("i",{className:"fas fa-file-export w-4"})," Exportar"),React.createElement("div",{className:"ml-auto flex items-center gap-2"},React.createElement(FlowFilter,{value:flowFilter,onChange:setFlowFilter}),React.createElement("div",{className:"relative"},React.createElement("i",{className:"fas fa-search w-4 h-4 text-slate-400 absolute left-3 top-2.5"}),React.createElement("input",{placeholder:"Buscar (RFC, UUID, descripci\xF3n)",className:"pl-9 pr-3 py-2 border rounded-xl text-sm w-72 focus:ring-2 focus:ring-slate-300 outline-none",onChange:function onChange(event){var value=event.target.value.toLowerCase();var customEvent=new CustomEvent("bank-search",{detail:{value:value}});window.dispatchEvent(customEvent)}})),React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-white border px-3 py-2 text-sm hover:bg-slate-50"},React.createElement("i",{className:"fas fa-filter w-4"})," Filtros")))};var ColumnHeader=function ColumnHeader(_ref10){var iconClass=_ref10.iconClass,title=_ref10.title,subtitle=_ref10.subtitle,cta=_ref10.cta,_ref10$tone=_ref10.tone,tone=_ref10$tone===void 0?"neutral":_ref10$tone;return React.createElement("div",{className:"flex items-center justify-between px-3 py-2 border-b ".concat(tone==="success"?"bg-emerald-50 border-emerald-200":tone==="warning"?"bg-amber-50 border-amber-200":tone==="danger"?"bg-red-50 border-red-200":"bg-slate-50 border-slate-200")},React.createElement("div",{className:"flex items-center gap-2"},React.createElement("i",{className:"".concat(iconClass," w-4 h-4")}),React.createElement("div",{className:"font-medium"},title),subtitle&&React.createElement("div",{className:"text-slate-500 text-xs"},subtitle)),cta)};var SmartTableHeader=function SmartTableHeader(){return React.createElement("div",{className:"grid grid-cols-[28px_110px_1fr_140px_220px_110px_200px_110px] gap-3 px-3 py-2 text-xs text-slate-500 border-b bg-slate-50"},React.createElement("div",null),React.createElement("div",null,"Fecha"),React.createElement("div",null,"Descripci\xF3n banco"),React.createElement("div",{className:"text-right pr-4"},"Monto"),React.createElement("div",null,"Sugerencia"),React.createElement("div",null,"Confianza"),React.createElement("div",null,"Badges"),React.createElement("div",{className:"text-right"},"Acci\xF3n"))};var Row=function Row(_ref11){var _row$invoice2,_row$invoice3,_row$invoice4,_row$invoice5;var row=_ref11.row,onOpenDrawer=_ref11.onOpenDrawer,expandedId=_ref11.expandedId,setExpandedId=_ref11.setExpandedId;var isOpen=expandedId===row.id;var ppdInfo=row.ppd?computePPDInfo(row):null;var isIntl=isIntlWithoutCfdi(row.raw);return React.createElement("div",{className:"border-b"},React.createElement("div",{className:"grid grid-cols-[28px_110px_1fr_140px_220px_110px_200px_110px] items-center gap-3 px-3 py-3 hover:bg-slate-50"},React.createElement("button",{"aria-label":isOpen?"Contraer":"Expandir",className:"inline-flex items-center justify-center w-6 h-6 rounded hover:bg-slate-100 border",onClick:function onClick(){return setExpandedId(isOpen?null:row.id)}},React.createElement("span",{className:"transition-transform ".concat(isOpen?"rotate-180":"")},"\u2304")),React.createElement("div",{className:"text-sm text-slate-600"},formatDate(row.date)),React.createElement("div",{className:"text-sm font-medium text-slate-800 truncate",title:row.description},row.description),React.createElement("div",{className:"text-sm tabular-nums font-semibold text-slate-900 text-right pr-4"},formatCurrency(row.amount,row.currency)),React.createElement("div",{className:"text-sm text-slate-700 truncate",title:row.suggestion},row.suggestion||"Sin sugerencia"),React.createElement("div",{className:"text-sm text-slate-700"},row.confidence,"%"),React.createElement("div",{className:"flex items-center gap-1 flex-wrap"},row.badges.map(function(badge,index){return React.createElement(Badge,{key:"".concat(row.id,"-badge-").concat(index),tone:badge.tone},badge.label)})),React.createElement("div",{className:"flex justify-end"},React.createElement("button",{className:"inline-flex items-center gap-1 rounded-lg bg-slate-900 text-white px-3 py-1.5 text-xs hover:bg-black",onClick:function onClick(event){event.stopPropagation();onOpenDrawer===null||onOpenDrawer===void 0||onOpenDrawer(row)}},"Conciliar ",React.createElement("i",{className:"fas fa-chevron-right w-3 h-3"})))),isOpen&&React.createElement("div",{className:"px-10 pb-4 bg-slate-50/60"},React.createElement("div",{className:"flex items-start justify-between gap-6"},React.createElement("div",{className:"flex-1"},React.createElement("div",{className:"text-xs uppercase text-slate-500"},"Descripci\xF3n del banco"),React.createElement("div",{className:"text-sm text-slate-800 whitespace-pre-wrap"},row.bankLongDescription||row.description)),row.onGotoStatement&&React.createElement("div",null,React.createElement("button",{className:"text-xs underline text-slate-700 hover:text-slate-900",onClick:function onClick(){return row.onGotoStatement(row)}},"Ir al rengl\xF3n en el extracto \u2192"))),row.ppd&&ppdInfo&&React.createElement("div",{className:"mt-4 rounded-xl border bg-white overflow-hidden"},React.createElement("div",{className:"px-3 py-2 border-b bg-amber-50 text-xs text-amber-700 uppercase flex items-center gap-2"},React.createElement("i",{className:"fas fa-badge-percent"}),"Pago PPD \xB7 Progreso ",ppdInfo.percent,"% \xB7 Saldo: ",formatCurrency(ppdInfo.remaining,row.currency)," \xB7 Parcialidad prevista #",ppdInfo.nextParcialidad),React.createElement("div",{className:"p-3 space-y-3 text-sm"},React.createElement("div",null,React.createElement("div",{className:"h-2 bg-slate-200 rounded"},React.createElement("div",{className:"h-2 rounded bg-slate-900",style:{width:"".concat(ppdInfo.percent,"%")}})),React.createElement("div",{className:"mt-1 text-slate-500"},"Pagado ",formatCurrency(ppdInfo.paid,row.currency)," de ",formatCurrency(ppdInfo.total,row.currency)," (",ppdInfo.percent,"%) \xB7 Este movimiento: ",ppdInfo.currentPaymentPercent,"%")),React.createElement("div",null,React.createElement("div",{className:"text-xs uppercase text-slate-500 mb-1"},"Complementos de pago registrados"),ppdInfo.complements.length?React.createElement("table",{className:"w-full text-xs"},React.createElement("thead",{className:"bg-slate-50"},React.createElement("tr",null,React.createElement("th",{className:"text-left p-2"},"Fecha"),React.createElement("th",{className:"text-left p-2"},"UUID"),React.createElement("th",{className:"text-right p-2"},"Parcialidad"),React.createElement("th",{className:"text-right p-2"},"Imp. Pagado"),React.createElement("th",{className:"text-right p-2"},"Saldo posterior"))),React.createElement("tbody",null,ppdInfo.complements.map(function(item,index){return React.createElement("tr",{key:index,className:"border-t"},React.createElement("td",{className:"p-2"},item.date||item.fecha||"\u2014"),React.createElement("td",{className:"p-2 truncate",title:item.uuid},item.uuid||"\u2014"),React.createElement("td",{className:"p-2 text-right"},item.numParcialidad||item.parcialidad||"\u2014"),React.createElement("td",{className:"p-2 text-right tabular-nums"},formatCurrency(item.amountPaid||item.amount_paid||item.importe_pagado,row.currency)),React.createElement("td",{className:"p-2 text-right tabular-nums"},formatCurrency(item.remainingBalance||item.saldo_posterior,row.currency)))}))):React.createElement("div",{className:"text-slate-500"},"A\xFAn no se registran complementos de pago para este CFDI.")),React.createElement("div",{className:"flex flex-wrap gap-2"},React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Registrar complemento"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Conciliar provisional"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Ver en SAT")))),isIntl&&React.createElement("div",{className:"mt-4 rounded-xl border bg-white overflow-hidden"},React.createElement("div",{className:"px-3 py-2 border-b bg-blue-50 text-xs text-blue-700 uppercase flex items-center gap-2"},React.createElement("i",{className:"fas fa-globe"}),"Servicio/Producto Internacional (sin CFDI)"),React.createElement("div",{className:"p-3 space-y-3 text-sm"},React.createElement("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3"},React.createElement("div",null,React.createElement("div",{className:"text-slate-500 text-xs uppercase"},"Detecci\xF3n"),React.createElement("ul",{className:"list-disc ml-4 text-slate-700"},row.currency&&React.createElement("li",null,"Moneda detectada: ",React.createElement("strong",null,row.currency)),React.createElement("li",null,"Merchant: ",React.createElement("strong",null,row.description)),React.createElement("li",null,"Heur\xEDstica: Moneda\u2260MXN o merchant internacional"))),React.createElement("div",null,React.createElement("div",{className:"text-slate-500 text-xs uppercase"},"Acciones recomendadas"),React.createElement("ul",{className:"list-disc ml-4 text-slate-700"},React.createElement("li",null,"Adjuntar ",React.createElement("strong",null,"factura extranjera")," o recibo"),React.createElement("li",null,"Registrar ",React.createElement("strong",null,"IVA de importaci\xF3n")," si aplica"),React.createElement("li",null,"Marcar como ",React.createElement("strong",null,"no deducible")," si no hay soporte v\xE1lido")))),React.createElement("div",{className:"flex flex-wrap gap-2"},React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Adjuntar factura extranjera"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Crear p\xF3liza internacional"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Marcar como no deducible")))),React.createElement("div",{className:"mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4"},React.createElement("div",{className:"rounded-xl border bg-white overflow-hidden"},React.createElement("div",{className:"px-3 py-2 border-b bg-slate-50 text-xs text-slate-500 uppercase"},"CFDI sugerido"),React.createElement("div",{className:"p-3 space-y-2"},React.createElement("div",{className:"text-sm font-medium text-slate-800"},((_row$invoice2=row.invoice)===null||_row$invoice2===void 0?void 0:_row$invoice2.supplierName)||row.suggestion||"Sin CFDI"),row.invoice&&React.createElement("table",{className:"w-full text-sm"},React.createElement("tbody",null,React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-1 text-slate-500"},"UUID"),React.createElement("td",{className:"p-1 text-right font-medium"},row.invoice.uuid||"\u2014")),row.invoice.paymentMethod&&React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-1 text-slate-500"},"M\xE9todo de pago"),React.createElement("td",{className:"p-1 text-right font-medium"},row.invoice.paymentMethod)),React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-1 text-slate-500"},"Subtotal"),React.createElement("td",{className:"p-1 text-right tabular-nums"},formatCurrency(row.invoice.subtotal,row.currency))),React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-1 text-slate-500"},"IVA"),React.createElement("td",{className:"p-1 text-right tabular-nums"},formatCurrency(row.invoice.taxes.iva,row.currency))),React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-1 text-slate-500"},"IEPS"),React.createElement("td",{className:"p-1 text-right tabular-nums"},formatCurrency(row.invoice.taxes.ieps,row.currency))),React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-1 text-slate-500"},"Retenciones"),React.createElement("td",{className:"p-1 text-right tabular-nums"},formatCurrency(row.invoice.taxes.retenciones,row.currency))),React.createElement("tr",{className:"border-t bg-slate-50 font-semibold"},React.createElement("td",{className:"p-1"},"Total CFDI"),React.createElement("td",{className:"p-1 text-right tabular-nums"},formatCurrency(row.invoice.total,row.currency))))))),React.createElement("div",{className:"rounded-xl border bg-white overflow-hidden"},React.createElement("div",{className:"px-3 py-2 border-b bg-slate-50 text-xs text-slate-500 uppercase"},"Contraste vs banco"),React.createElement("div",{className:"p-3 space-y-1 text-sm"},row.ppd?React.createElement(React.Fragment,null,React.createElement("div",{className:"flex items-center justify-between"},React.createElement("span",{className:"text-slate-500"},"Monto en banco (este pago)"),React.createElement("span",{className:"font-semibold tabular-nums"},formatCurrency(row.amount,row.currency))),React.createElement("div",{className:"flex items-center justify-between"},React.createElement("span",{className:"text-slate-500"},"Complemento estimado a conciliar"),React.createElement("span",{className:"font-semibold tabular-nums"},formatCurrency(row.amount,row.currency))),React.createElement("div",{className:"flex items-center justify-between border-t pt-2 mt-2"},React.createElement("span",{className:"text-slate-500"},"Saldo insoluto tras este pago"),React.createElement("span",{className:"font-semibold tabular-nums"},formatCurrency(Math.max(0,ppdInfo.remaining-row.amount),row.currency)))):React.createElement(React.Fragment,null,React.createElement("div",{className:"flex items-center justify-between"},React.createElement("span",{className:"text-slate-500"},"Monto en banco"),React.createElement("span",{className:"font-semibold tabular-nums"},formatCurrency(row.amount,row.currency))),React.createElement("div",{className:"flex items-center justify-between"},React.createElement("span",{className:"text-slate-500"},"Total CFDI"),React.createElement("span",{className:"font-semibold tabular-nums"},formatCurrency(((_row$invoice3=row.invoice)===null||_row$invoice3===void 0?void 0:_row$invoice3.total)||0,row.currency))),React.createElement("div",{className:"flex items-center justify-between border-t pt-2 mt-2"},React.createElement("span",{className:"text-slate-500"},"Diferencia"),React.createElement("span",{className:"font-semibold tabular-nums ".concat((((_row$invoice4=row.invoice)===null||_row$invoice4===void 0?void 0:_row$invoice4.total)||0)-row.amount===0?"text-emerald-700":"text-amber-700")},formatCurrency((((_row$invoice5=row.invoice)===null||_row$invoice5===void 0?void 0:_row$invoice5.total)||0)-row.amount,row.currency))))))),React.createElement("div",{className:"mt-4 rounded-xl border bg-white overflow-hidden"},React.createElement("div",{className:"px-3 py-2 border-b bg-slate-50 text-xs text-slate-500 uppercase"},"P\xF3liza contable (previa)"),React.createElement("table",{className:"w-full text-sm"},React.createElement("thead",{className:"bg-slate-50"},React.createElement("tr",null,React.createElement("th",{className:"text-left p-2 font-medium text-slate-600"},"Cuenta"),React.createElement("th",{className:"text-left p-2 font-medium text-slate-600"},"Concepto"),React.createElement("th",{className:"text-right p-2 font-medium text-slate-600"},"Debe"),React.createElement("th",{className:"text-right p-2 font-medium text-slate-600"},"Haber"))),React.createElement("tbody",null,(row.policyPreview||[{account:"572-01 Comisiones Bancarias",concept:"Cargo autom\xE1tico banco",debit:Math.abs(row.amount),credit:0},{account:"102 Bancos",concept:"Salida de fondos",debit:0,credit:Math.abs(row.amount)}]).map(function(line,index){return React.createElement("tr",{key:index,className:"border-t"},React.createElement("td",{className:"p-2"},line.account||"\u2014"),React.createElement("td",{className:"p-2"},line.concept||"\u2014"),React.createElement("td",{className:"p-2 text-right tabular-nums"},formatCurrency(line.debit,row.currency)),React.createElement("td",{className:"p-2 text-right tabular-nums"},formatCurrency(line.credit,row.currency)))}))))))};var Drawer=function Drawer(_ref12){var open=_ref12.open,onClose=_ref12.onClose,row=_ref12.row,onConciliate=_ref12.onConciliate,conciliateLoading=_ref12.conciliateLoading;if(!open||!row)return null;return React.createElement("div",{className:"fixed inset-0 z-40"},React.createElement("div",{className:"absolute inset-0 bg-black/30",onClick:onClose}),React.createElement("div",{className:"absolute right-0 top-0 h-full w-full max-w-[520px] bg-white shadow-2xl p-6 overflow-y-auto"},React.createElement("div",{className:"flex items-start justify-between"},React.createElement("div",null,React.createElement("div",{className:"text-xs uppercase text-slate-500"},"Revisi\xF3n de movimiento"),React.createElement("div",{className:"text-lg font-semibold text-slate-900 mt-1"},formatCurrency(row.amount,row.currency)," \xB7 ",formatDate(row.date)),React.createElement("div",{className:"text-slate-600 mt-1"},row.description)),React.createElement("button",{className:"text-slate-500 hover:text-slate-800",onClick:onClose},"\u2715")),React.createElement("div",{className:"mt-6 space-y-3"},React.createElement("div",{className:"text-xs font-medium text-slate-500"},"Mejores coincidencias"),row.suggestions.length===0&&React.createElement("div",{className:"rounded-xl border border-dashed border-slate-200 p-4 text-sm text-slate-500"},"Sin sugerencias disponibles para este movimiento."),row.suggestions.map(function(suggestion,index){return React.createElement("div",{key:index,className:"rounded-xl border p-3 hover:bg-slate-50"},React.createElement("div",{className:"flex items-center justify-between"},React.createElement("div",{className:"font-medium text-slate-800 truncate"},suggestion.title),React.createElement(Badge,{tone:index===0?"success":"neutral"},suggestion.score,"%")),React.createElement("div",{className:"text-sm text-slate-600 mt-1"},suggestion.detail||"Sin detalle adicional"),React.createElement("div",{className:"flex items-center gap-2 mt-2 text-xs text-slate-500"},React.createElement("span",{className:"inline-flex items-center gap-1"},React.createElement("i",{className:"fas fa-scale-unbalanced"})," Monto"),React.createElement("span",{className:"inline-flex items-center gap-1"},React.createElement("i",{className:"fas fa-calendar"})," Fecha"),React.createElement("span",{className:"inline-flex items-center gap-1"},React.createElement("i",{className:"fas fa-link"})," Referencia")),React.createElement("div",{className:"mt-3 flex gap-2"},React.createElement("button",{className:"rounded-lg bg-slate-900 text-white px-3 py-1.5 text-xs disabled:opacity-60",onClick:function onClick(){return onConciliate(row,suggestion)},disabled:conciliateLoading},conciliateLoading?"Conciliando\u2026":"Conciliar con esta"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Ver CFDI")))})),React.createElement("div",{className:"mt-6 space-y-2"},React.createElement("div",{className:"text-xs font-medium text-slate-500"},"Acciones r\xE1pidas"),React.createElement("div",{className:"flex flex-wrap gap-2"},React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Dividir / Prorratear"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Vincular CFDI manual"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Marcar excepci\xF3n"),React.createElement("button",{className:"rounded-lg border px-3 py-1.5 text-xs"},"Crear p\xF3liza sugerida"))),React.createElement("div",{className:"mt-6"},React.createElement("div",{className:"text-xs font-medium text-slate-500"},"P\xF3liza simulada"),React.createElement("div",{className:"mt-2 rounded-xl border overflow-hidden"},React.createElement("table",{className:"w-full text-sm"},React.createElement("thead",{className:"bg-slate-50"},React.createElement("tr",null,React.createElement("th",{className:"text-left p-2 font-medium text-slate-600"},"Cuenta"),React.createElement("th",{className:"text-left p-2 font-medium text-slate-600"},"Descripci\xF3n"),React.createElement("th",{className:"text-right p-2 font-medium text-slate-600"},"Debe"),React.createElement("th",{className:"text-right p-2 font-medium text-slate-600"},"Haber"))),React.createElement("tbody",null,React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-2"},"572-01 Comisiones Bancarias"),React.createElement("td",{className:"p-2"},"Cargo autom\xE1tico banco"),React.createElement("td",{className:"p-2 text-right tabular-nums"},formatCurrency(Math.abs(row.amount),row.currency)),React.createElement("td",{className:"p-2 text-right tabular-nums"},"0.00")),React.createElement("tr",{className:"border-t"},React.createElement("td",{className:"p-2"},"102 Bancos"),React.createElement("td",{className:"p-2"},"Salida de fondos"),React.createElement("td",{className:"p-2 text-right tabular-nums"},"0.00"),React.createElement("td",{className:"p-2 text-right tabular-nums"},formatCurrency(Math.abs(row.amount),row.currency))))))),React.createElement("div",{className:"mt-6 flex items-center gap-2"},React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-slate-900 text-white px-4 py-2 text-sm disabled:opacity-60",onClick:function onClick(){return onConciliate(row,row.suggestions[0]||null)},disabled:conciliateLoading},React.createElement("i",{className:"fas fa-check-circle"}),conciliateLoading?"Conciliando\u2026":"Conciliar"),React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-white border px-4 py-2 text-sm"},React.createElement("i",{className:"fas fa-xmark-circle"})," Reabrir / Descartar"))))};var SatImportModal=function SatImportModal(_ref13){var isOpen=_ref13.isOpen,onClose=_ref13.onClose,onProcessed=_ref13.onProcessed;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),files=_useState2[0],setFiles=_useState2[1];var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),processing=_useState4[0],setProcessing=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),results=_useState6[0],setResults=_useState6[1];var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),summary=_useState8[0],setSummary=_useState8[1];var _useState9=useState(null),_useState0=_slicedToArray(_useState9,2),error=_useState0[0],setError=_useState0[1];var totalSizeMb=files.reduce(function(sum,file){return sum+file.size},0)/(1024*1024);useEffect(function(){if(!isOpen){setFiles([]);setProcessing(false);setResults([]);setSummary(null);setError(null)}},[isOpen]);var handleFileChange=function handleFileChange(event){var selected=Array.from(event.target.files||[]);setFiles(selected);setResults([]);setSummary(null);setError(null)};var clearSelection=function clearSelection(){setFiles([]);setResults([]);setSummary(null);setError(null)};var processFiles=function(){var _ref14=_asyncToGenerator(_regenerator().m(function _callee(){var companyId,invoicesPayload,partialResults,_iterator,_step,_parsed,_metadata$emisor,file,extension,rawXml,formData,parsed,_response,_text,metadata,matchResults,response,text,payload,combinedResults,_t,_t2,_t3,_t4;return _regenerator().w(function(_context){while(1)switch(_context.p=_context.n){case 0:if(!(processing||files.length===0)){_context.n=1;break}return _context.a(2);case 1:setProcessing(true);setError(null);companyId=getActiveCompanyId();invoicesPayload=[];partialResults=[];_context.p=2;_iterator=_createForOfIteratorHelper(files);_context.p=3;_iterator.s();case 4:if((_step=_iterator.n()).done){_context.n=15;break}file=_step.value;extension=(file.name.split(".").pop()||"").toLowerCase();if(!(extension!=="xml")){_context.n=5;break}partialResults.push({filename:file.name,status:"unsupported",message:"Solo se admiten archivos XML."});return _context.a(3,14);case 5:_context.n=6;return file.text();case 6:rawXml=_context.v;formData=new FormData;formData.append("file",file,file.name);parsed=void 0;_context.p=7;_context.n=8;return fetch("/invoices/parse",{method:"POST",body:formData});case 8:_response=_context.v;if(_response.ok){_context.n=10;break}_context.n=9;return _response.text();case 9:_text=_context.v;partialResults.push({filename:file.name,status:"error",message:"Error interpretando CFDI: ".concat(_text||_response.status)});return _context.a(3,14);case 10:_context.n=11;return _response.json();case 11:parsed=_context.v;_context.n=13;break;case 12:_context.p=12;_t=_context.v;console.error("Error parsing CFDI",_t);partialResults.push({filename:file.name,status:"error",message:"Error interno al procesar el CFDI."});return _context.a(3,14);case 13:metadata=((_parsed=parsed)===null||_parsed===void 0?void 0:_parsed.metadata)||{};invoicesPayload.push({filename:file.name,uuid:metadata.uuid||parsed.uuid||null,total:toNumber(parsed.total,0),issued_at:metadata.fecha_emision||metadata.fecha||parsed.fecha_emision||parsed.issued_at||null,rfc_emisor:(metadata===null||metadata===void 0||(_metadata$emisor=metadata.emisor)===null||_metadata$emisor===void 0?void 0:_metadata$emisor.rfc)||parsed.rfc_emisor||null,raw_xml:rawXml,metadata:metadata});case 14:_context.n=4;break;case 15:_context.n=17;break;case 16:_context.p=16;_t2=_context.v;_iterator.e(_t2);case 17:_context.p=17;_iterator.f();return _context.f(17);case 18:matchResults=[];if(!(invoicesPayload.length>0)){_context.n=26;break}_context.p=19;_context.n=20;return fetch("/invoices/bulk-match",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({company_id:companyId,invoices:invoicesPayload,auto_mark_invoiced:true})});case 20:response=_context.v;if(response.ok){_context.n=22;break}_context.n=21;return response.text();case 21:text=_context.v;partialResults.push({filename:undefined,status:"error",message:"Error conciliando facturas: ".concat(text||response.status)});_context.n=24;break;case 22:_context.n=23;return response.json();case 23:payload=_context.v;matchResults=Array.isArray(payload===null||payload===void 0?void 0:payload.results)?payload.results:[];case 24:_context.n=26;break;case 25:_context.p=25;_t3=_context.v;console.error("Error matching invoices",_t3);partialResults.push({filename:undefined,status:"error",message:"Error interno al conciliar las facturas."});case 26:combinedResults=[].concat(_toConsumableArray(matchResults),partialResults);setResults(combinedResults);setSummary({total:files.length,sent_to_match:invoicesPayload.length,linked:combinedResults.filter(function(item){return item.status==="linked"}).length,needs_review:combinedResults.filter(function(item){return item.status==="needs_review"}).length,errors:combinedResults.filter(function(item){return item.status==="error"}).length,unsupported:combinedResults.filter(function(item){return item.status==="unsupported"}).length});if(onProcessed)onProcessed();_context.n=28;break;case 27:_context.p=27;_t4=_context.v;console.error("SAT import error",_t4);setError("Ocurri\xF3 un error procesando los CFDI. Intenta nuevamente.");case 28:_context.p=28;setProcessing(false);return _context.f(28);case 29:return _context.a(2)}},_callee,null,[[19,25],[7,12],[3,16,17,18],[2,27,28,29]])}));return function processFiles(){return _ref14.apply(this,arguments)}}();if(!isOpen)return null;return React.createElement("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"},React.createElement("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto"},React.createElement("div",{className:"px-6 py-4 border-b border-slate-200 flex items-center justify-between"},React.createElement("div",null,React.createElement("div",{className:"text-xs uppercase text-slate-500"},"Carga de CFDI"),React.createElement("h3",{className:"text-lg font-semibold text-slate-900"},"Importar CFDI desde SAT"),React.createElement("p",{className:"text-sm text-slate-500"},"Analiza archivos XML y conc\xEDlialos en lote contra tus gastos.")),React.createElement("button",{className:"text-slate-400 hover:text-slate-600",onClick:onClose},React.createElement("i",{className:"fas fa-times text-xl"}))),React.createElement("div",{className:"px-6 py-6 space-y-5"},React.createElement("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-4 text-sm text-emerald-800"},React.createElement("p",{className:"font-medium"},"\uD83D\uDCE4 Carga masiva o individual"),React.createElement("p",{className:"mt-1"},"Aceptamos CFDI XML (PDF se ignoran). Al finalizar ver\xE1s cu\xE1ntas facturas quedaron conciliadas, pendientes o con error.")),React.createElement("div",{className:"border-2 border-dashed border-slate-300 rounded-lg p-8 text-center"},React.createElement("input",{type:"file",multiple:true,accept:".xml",className:"hidden",id:"sat-invoice-input",onChange:handleFileChange}),React.createElement("label",{htmlFor:"sat-invoice-input",className:"cursor-pointer block"},React.createElement("i",{className:"fas fa-cloud-upload-alt text-4xl text-slate-400 mb-4"}),React.createElement("p",{className:"text-lg font-semibold text-slate-700"},"Arrastra o haz clic para seleccionar tus CFDI"),React.createElement("p",{className:"text-sm text-slate-500"},"Formato soportado: XML")),files.length>0&&React.createElement("div",{className:"mt-6 text-left space-y-2"},React.createElement("div",{className:"flex items-center justify-between text-sm text-slate-600"},React.createElement("span",{className:"font-semibold"},"Archivos seleccionados (",files.length,")"),React.createElement("span",null,totalSizeMb.toFixed(2)," MB totales")),React.createElement("div",{className:"space-y-2"},files.map(function(file){return React.createElement("div",{key:file.name,className:"flex items-center justify-between bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm"},React.createElement("span",{className:"font-medium text-slate-700 truncate"},file.name),React.createElement("span",{className:"text-xs text-slate-500"},(file.size/1024/1024).toFixed(2)," MB"))})))),error&&React.createElement("div",{className:"bg-red-50 border border-red-200 text-red-600 rounded-lg px-4 py-3 text-sm"},error),React.createElement("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"},React.createElement("button",{type:"button",className:"px-4 py-2 text-sm text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 disabled:opacity-40",onClick:clearSelection,disabled:processing||files.length===0},React.createElement("i",{className:"fas fa-eraser mr-2"}),"Limpiar selecci\xF3n"),React.createElement("button",{type:"button",className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50",onClick:processFiles,disabled:processing||files.length===0},React.createElement("i",{className:"fas ".concat(processing?"fa-spinner fa-spin":"fa-play"," mr-2")}),processing?"Procesando facturas...":"Procesar facturas seleccionadas")),summary&&React.createElement("div",{className:"border border-emerald-200 bg-emerald-50 rounded-lg p-4 text-sm text-emerald-800 space-y-1"},React.createElement("p",{className:"font-semibold"},"Resumen"),React.createElement("p",null,"Seleccionados: ",summary.total),React.createElement("p",null,"Conciliados autom\xE1ticamente: ",summary.linked),React.createElement("p",null,"Revisar manualmente: ",summary.needs_review),React.createElement("p",null,"Errores: ",summary.errors),React.createElement("p",null,"No soportados: ",summary.unsupported)),results.length>0&&React.createElement("div",{className:"space-y-2"},React.createElement("div",{className:"flex items-center justify-between"},React.createElement("h4",{className:"text-lg font-semibold text-slate-900 flex items-center gap-2"},React.createElement("i",{className:"fas fa-clipboard-list text-slate-600"}),"Resultados del procesamiento"),React.createElement("button",{type:"button",className:"inline-flex items-center gap-2 px-3 py-2 text-sm text-white bg-slate-900 rounded-lg hover:bg-black",onClick:function onClick(){var headers=["Archivo","Estado","Mensaje"];var rows=results.map(function(item){return[item.filename||"\u2014",item.status||"\u2014",item.message||"\u2014"]});var csv=[headers.join(",")].concat(_toConsumableArray(rows.map(function(row){return row.map(function(cell){return"\"".concat(String(cell).replace(/"/g,"\"\""),"\"")}).join(",")}))).join("\n");var blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});var url=URL.createObjectURL(blob);var link=document.createElement("a");link.href=url;link.setAttribute("download","resultados-cfdi-".concat(Date.now(),".csv"));document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url)}},React.createElement("i",{className:"fas fa-download"}),"Descargar reporte")),React.createElement("div",{className:"border border-slate-200 rounded-lg"},React.createElement("table",{className:"w-full text-sm"},React.createElement("thead",{className:"bg-slate-50"},React.createElement("tr",null,React.createElement("th",{className:"text-left p-2"},"Archivo"),React.createElement("th",{className:"text-left p-2"},"Estado"),React.createElement("th",{className:"text-left p-2"},"Mensaje"))),React.createElement("tbody",null,results.map(function(item,index){return React.createElement("tr",{key:index,className:"border-t"},React.createElement("td",{className:"p-2 text-slate-700"},item.filename||"\u2014"),React.createElement("td",{className:"p-2 text-slate-600 uppercase text-xs"},item.status||"\u2014"),React.createElement("td",{className:"p-2 text-slate-500"},item.message||item.note||"\u2014"))}))))))))};var buildGroups=function buildGroups(rows){return{aiReady:rows.filter(function(row){return!row.conciliated&&row.confidence>=85&&row.hasCfdi}),manual:rows.filter(function(row){return!row.conciliated&&row.confidence<85&&row.hasCfdi&&!row.badges.some(function(b){return b.label==="Sin CFDI"})}),ppd:rows.filter(function(row){return isPPD(row.raw)}),intl:rows.filter(function(row){return isIntlWithoutCfdi(row.raw)}),missingCfdi:rows.filter(function(row){return row.badges.some(function(badge){return badge.label==="Sin CFDI"})&&!isIntlWithoutCfdi(row.raw)}),transfers:rows.filter(function(row){return row.badges.some(function(badge){return /Propias/i.test(badge.label)})})}};var BankReconciliationApp=function BankReconciliationApp(){var _selectedAccountMeta$,_accountOptionMap$get;var _useState1=useState([]),_useState10=_slicedToArray(_useState1,2),rows=_useState10[0],setRows=_useState10[1];var _useState11=useState([]),_useState12=_slicedToArray(_useState11,2),availableAccounts=_useState12[0],setAvailableAccounts=_useState12[1];var _useState13=useState(true),_useState14=_slicedToArray(_useState13,2),loading=_useState14[0],setLoading=_useState14[1];var _useState15=useState(null),_useState16=_slicedToArray(_useState15,2),error=_useState16[0],setError=_useState16[1];var _useState17=useState("all"),_useState18=_slicedToArray(_useState17,2),flowFilter=_useState18[0],setFlowFilter=_useState18[1];var _useState19=useState("all"),_useState20=_slicedToArray(_useState19,2),statusFilter=_useState20[0],setStatusFilter=_useState20[1];var _useState21=useState("all"),_useState22=_slicedToArray(_useState21,2),selectedPeriod=_useState22[0],setSelectedPeriod=_useState22[1];var _useState23=useState("all"),_useState24=_slicedToArray(_useState23,2),selectedAccount=_useState24[0],setSelectedAccount=_useState24[1];var _useState25=useState(null),_useState26=_slicedToArray(_useState25,2),expandedId=_useState26[0],setExpandedId=_useState26[1];var _useState27=useState(null),_useState28=_slicedToArray(_useState27,2),drawerRow=_useState28[0],setDrawerRow=_useState28[1];var _useState29=useState(false),_useState30=_slicedToArray(_useState29,2),autoConciliating=_useState30[0],setAutoConciliating=_useState30[1];var _useState31=useState(false),_useState32=_slicedToArray(_useState31,2),satModalOpen=_useState32[0],setSatModalOpen=_useState32[1];var _useState33=useState(false),_useState34=_slicedToArray(_useState33,2),conciliateLoading=_useState34[0],setConciliateLoading=_useState34[1];var _useState35=useState(""),_useState36=_slicedToArray(_useState35,2),searchTerm=_useState36[0],setSearchTerm=_useState36[1];var _useState37=useState(null),_useState38=_slicedToArray(_useState37,2),summary=_useState38[0],setSummary=_useState38[1];var loadMovements=useCallback(_asyncToGenerator(_regenerator().m(function _callee3(){var companyId,buildParams,fetchMovements,payload,movementsResponse,accountsPayload,normalized,_t5;return _regenerator().w(function(_context3){while(1)switch(_context3.p=_context3.n){case 0:companyId=getActiveCompanyId();setLoading(true);setError(null);buildParams=function buildParams(overrideCompanyId){var params=new URLSearchParams({include_summary:"true",limit:"500"});var effectiveCompany=overrideCompanyId!==null&&overrideCompanyId!==void 0?overrideCompanyId:companyId;if(effectiveCompany&&!["","default","all"].includes(effectiveCompany)){params.set("company_id",effectiveCompany)}else if(effectiveCompany==="all"){params.set("company_id","all")}return params};fetchMovements=function(){var _ref16=_asyncToGenerator(_regenerator().m(function _callee2(params){var response;return _regenerator().w(function(_context2){while(1)switch(_context2.n){case 0:_context2.n=1;return fetch("/bank_reconciliation/movements?".concat(params.toString()));case 1:response=_context2.v;if(response.ok){_context2.n=2;break}throw new Error("Error ".concat(response.status));case 2:return _context2.a(2,response.json())}},_callee2)}));return function fetchMovements(_x){return _ref16.apply(this,arguments)}}();_context3.p=1;_context3.n=2;return fetchMovements(buildParams());case 2:payload=_context3.v;movementsResponse=Array.isArray(payload)?payload:Array.isArray(payload===null||payload===void 0?void 0:payload.movements)?payload.movements:[];accountsPayload=Array.isArray(payload===null||payload===void 0?void 0:payload.accounts)?payload.accounts.map(function(account){var _ref17,_account$id;if(!account)return null;var rawId=(_ref17=(_account$id=account.id)!==null&&_account$id!==void 0?_account$id:account.value)!==null&&_ref17!==void 0?_ref17:account.account_id;if(rawId===undefined||rawId===null)return null;return _objectSpread(_objectSpread({},account),{},{id:String(rawId),has_movements:Boolean(account.has_movements)})}).filter(Boolean):[];setAvailableAccounts(accountsPayload);if(movementsResponse.length===0){setRows([])}else{normalized=movementsResponse.map(mapMovementToRow);setRows(normalized)}setSummary((payload===null||payload===void 0?void 0:payload.summary)||null);_context3.n=4;break;case 3:_context3.p=3;_t5=_context3.v;console.error("Error loading movements",_t5);setError("No se pudieron cargar los movimientos bancarios.");setRows([]);setAvailableAccounts([]);setSummary(null);case 4:_context3.p=4;setLoading(false);return _context3.f(4);case 5:return _context3.a(2)}},_callee3,null,[[1,3,4,5]])})),[]);useEffect(function(){loadMovements()},[loadMovements]);useEffect(function(){var handler=function handler(event){setSearchTerm(event.detail.value)};window.addEventListener("bank-search",handler);return function(){return window.removeEventListener("bank-search",handler)}},[]);var periodOptions=useMemo(function(){var unique=new Set;rows.forEach(function(row){if(row.period){unique.add(row.period)}});return Array.from(unique).sort().reverse()},[rows]);var periodRows=useMemo(function(){if(!selectedPeriod||selectedPeriod==="all")return rows;return rows.filter(function(row){return row.period===selectedPeriod})},[rows,selectedPeriod]);var accountOptions=useMemo(function(){var map=new Map;availableAccounts.forEach(function(account){if(!account||account.id===undefined||account.id===null)return;var value=String(account.id);var baseLabel=(account.label||account.name||"Cuenta ".concat(value)).trim();var label=account.has_movements?baseLabel:"".concat(baseLabel," (Sin movimientos)");map.set(value,{value:value,label:label,baseLabel:baseLabel,hasMovements:Boolean(account.has_movements)})});rows.forEach(function(row){if(!row.accountId)return;var value=String(row.accountId);if(map.has(value))return;var baseLabel=(row.accountLabel||"Cuenta ".concat(value)).trim();map.set(value,{value:value,label:baseLabel,baseLabel:baseLabel,hasMovements:true})});return Array.from(map.values()).sort(function(a,b){return a.label.localeCompare(b.label)})},[rows,availableAccounts]);var accountOptionMap=useMemo(function(){var map=new Map;accountOptions.forEach(function(option){return map.set(option.value,option)});return map},[accountOptions]);var selectedAccountMeta=selectedAccount==="all"?null:accountOptionMap.get(selectedAccount);var headerAccount=(_selectedAccountMeta$=selectedAccountMeta===null||selectedAccountMeta===void 0?void 0:selectedAccountMeta.baseLabel)!==null&&_selectedAccountMeta$!==void 0?_selectedAccountMeta$:"Todas las cuentas";var headerPeriod=selectedPeriod==="all"?"Todos los periodos":formatPeriodLabel(selectedPeriod);useEffect(function(){if(selectedAccount!=="all"&&!accountOptionMap.has(selectedAccount)){setSelectedAccount("all")}},[selectedAccount,accountOptionMap]);var filteredRows=useMemo(function(){return periodRows.filter(function(row){if(flowFilter!=="all"&&row.flow!==flowFilter){return false}if(statusFilter==="conciliated"&&!row.conciliated){return false}if(statusFilter==="pending"&&row.conciliated){return false}if(selectedAccount!=="all"&&row.accountId!==selectedAccount){return false}if(searchTerm){var _row$invoice6;var target="".concat(row.description," ").concat(row.suggestion," ").concat(((_row$invoice6=row.invoice)===null||_row$invoice6===void 0?void 0:_row$invoice6.uuid)||"").toLowerCase();if(!target.includes(searchTerm)){return false}}return true})},[periodRows,flowFilter,statusFilter,selectedAccount,searchTerm]);var groups=useMemo(function(){return buildGroups(filteredRows)},[filteredRows]);var kpi=useMemo(function(){var _summary$total,_summary$conciliated;var usePeriod=selectedPeriod!=="all";var baseRows=usePeriod?periodRows:rows;var total=usePeriod?baseRows.length:(_summary$total=summary===null||summary===void 0?void 0:summary.total)!==null&&_summary$total!==void 0?_summary$total:baseRows.length;var conciliated=usePeriod?baseRows.filter(function(row){return row.conciliated}).length:(_summary$conciliated=summary===null||summary===void 0?void 0:summary.conciliated)!==null&&_summary$conciliated!==void 0?_summary$conciliated:baseRows.filter(function(row){return row.conciliated}).length;var pending=total-conciliated;var autoMatch=total>0?Math.round(baseRows.filter(function(row){return row.confidence>=85}).length/total*100):0;var periodTotal=periodRows.length;var periodConciliated=periodRows.filter(function(row){return row.conciliated}).length;var periodStatus="Sin datos";var periodTone="neutral";var periodHint="Sin movimientos en este periodo";if(periodTotal>0){if(periodConciliated===periodTotal){periodStatus="Conciliado";periodTone="success";periodHint="Todo cuadrado este mes"}else if(periodConciliated===0){periodStatus="Pendiente";periodTone="danger";periodHint="A\xFAn no hay conciliaciones registradas"}else{periodStatus="En progreso";periodTone="warning";periodHint="".concat(periodConciliated," de ").concat(periodTotal," conciliados")}}return{conciliated:conciliated,pending:pending,autoMatch:autoMatch,periodStatus:periodStatus,periodTone:periodTone,periodHint:periodHint}},[rows,periodRows,summary,selectedPeriod]);var handleAutoConciliate=function(){var _ref18=_asyncToGenerator(_regenerator().m(function _callee4(){var response,result,_t6;return _regenerator().w(function(_context4){while(1)switch(_context4.p=_context4.n){case 0:setAutoConciliating(true);_context4.p=1;_context4.n=2;return fetch("/bank_reconciliation/auto-reconcile",{method:"POST",headers:{"Content-Type":"application/json"}});case 2:response=_context4.v;if(response.ok){_context4.n=3;break}throw new Error("Auto reconcile failed");case 3:_context4.n=4;return response.json();case 4:result=_context4.v;showToast("Auto-conciliaci\xF3n completada: ".concat(result.matched||0," movimientos"),"success");_context4.n=5;return loadMovements();case 5:_context4.n=7;break;case 6:_context4.p=6;_t6=_context4.v;console.error("Auto reconcile error",_t6);showToast("Error en auto-conciliaci\xF3n","error");case 7:_context4.p=7;setAutoConciliating(false);return _context4.f(7);case 8:return _context4.a(2)}},_callee4,null,[[1,6,7,8]])}));return function handleAutoConciliate(){return _ref18.apply(this,arguments)}}();var handleUploadMovements=function handleUploadMovements(){showToast("Feature en construcci\xF3n: subida de movimientos","info")};var handleExport=function handleExport(){var headers=["ID","Fecha","Descripci\xF3n","Monto","Confianza","Estado"];var rowsCsv=rows.map(function(row){return[row.id,row.date,row.description,row.amount,"".concat(row.confidence,"%"),row.conciliated?"Conciliado":"Pendiente"]});var csv=[headers.join(",")].concat(_toConsumableArray(rowsCsv.map(function(cells){return cells.map(function(cell){return"\"".concat(String(cell).replace(/"/g,"\"\""),"\"")}).join(",")}))).join("\n");var blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});var url=URL.createObjectURL(blob);var link=document.createElement("a");link.href=url;link.setAttribute("download","conciliacion-".concat(Date.now(),".csv"));document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url)};var handleConciliate=function(){var _ref19=_asyncToGenerator(_regenerator().m(function _callee5(row,suggestion){var _row$raw,_row$raw2,_suggestion$score2,movementId,_t7;return _regenerator().w(function(_context5){while(1)switch(_context5.p=_context5.n){case 0:if(!conciliateLoading){_context5.n=1;break}return _context5.a(2);case 1:setConciliateLoading(true);_context5.p=2;movementId=((_row$raw=row.raw)===null||_row$raw===void 0?void 0:_row$raw.movement_id)||((_row$raw2=row.raw)===null||_row$raw2===void 0?void 0:_row$raw2.id)||row.id;if(movementId){_context5.n=3;break}throw new Error("movement_id missing");case 3:_context5.n=4;return fetch("/bank_reconciliation/feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({movement_id:movementId,decision:"accepted",score:(_suggestion$score2=suggestion===null||suggestion===void 0?void 0:suggestion.score)!==null&&_suggestion$score2!==void 0?_suggestion$score2:row.confidence,metadata:(suggestion===null||suggestion===void 0?void 0:suggestion.raw)||{}})});case 4:showToast("Movimiento conciliado correctamente","success");setDrawerRow(null);_context5.n=5;return loadMovements();case 5:_context5.n=7;break;case 6:_context5.p=6;_t7=_context5.v;console.error("Conciliate error",_t7);showToast("No se pudo conciliar el movimiento","error");case 7:_context5.p=7;setConciliateLoading(false);return _context5.f(7);case 8:return _context5.a(2)}},_callee5,null,[[2,6,7,8]])}));return function handleConciliate(_x2,_x3){return _ref19.apply(this,arguments)}}();if(loading){return React.createElement("div",{className:"flex items-center justify-center py-24"},React.createElement("div",{className:"flex flex-col items-center gap-3 text-slate-600"},React.createElement("i",{className:"fas fa-spinner fa-spin text-2xl"}),"Cargando conciliaci\xF3n bancaria..."))}if(error){return React.createElement("div",{className:"flex items-center justify-center py-24"},React.createElement("div",{className:"bg-red-50 border border-red-200 text-red-600 px-6 py-4 rounded-lg"},error))}return React.createElement("div",{className:"min-h-screen bg-slate-100"},React.createElement("section",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},React.createElement("header",{className:"page-header"},React.createElement("div",{className:"page-header__content"},React.createElement("div",{className:"page-header__meta"},React.createElement("h1",{className:"page-header__title"},React.createElement("span",{"aria-hidden":"true"},"\uD83D\uDD04")," Conciliaci\xF3n Bancaria Inteligente"),React.createElement("p",{className:"page-header__subtitle"},"Relaciona movimientos bancarios con CFDI y gastos para cerrar el ciclo financiero.")),React.createElement("div",{className:"page-header__actions"},React.createElement("span",{className:"badge-secondary"},"Banco \u2192 CFDI \u2192 Gasto"))))),React.createElement("div",{className:"sticky top-0 z-30 border-b bg-white/90 backdrop-blur"},React.createElement("div",{className:"max-w-7xl mx-auto px-4 py-3 flex flex-col gap-3"},React.createElement("div",{className:"flex items-center gap-3"},React.createElement("div",null,React.createElement("div",{className:"text-xs text-slate-500 uppercase"},"Cuenta \xB7 Periodo"),React.createElement("div",{className:"text-lg font-semibold"},headerAccount," \xB7 ",headerPeriod)),React.createElement("div",{className:"h-8 w-px bg-slate-200"}),React.createElement("div",{className:"text-xs text-slate-500"},"\xDAltima ejecuci\xF3n: ",new Date().toLocaleString("es-MX"))),React.createElement(Toolbar,{flowFilter:flowFilter,setFlowFilter:setFlowFilter,onAutoConciliate:handleAutoConciliate,autoConciliating:autoConciliating,onUploadMovements:handleUploadMovements,onOpenSatModal:function onOpenSatModal(){return setSatModalOpen(true)},onExport:handleExport}),React.createElement("div",{className:"flex flex-wrap items-center gap-4"},React.createElement("div",null,React.createElement("label",{className:"block text-xs font-semibold text-slate-500 uppercase mb-1"},"Periodo"),React.createElement("select",{value:selectedPeriod,onChange:function onChange(event){return setSelectedPeriod(event.target.value)},className:"border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white",disabled:!periodOptions.length},React.createElement("option",{value:"all"},"Todos los periodos"),periodOptions.map(function(period){return React.createElement("option",{key:period,value:period},formatPeriodLabel(period))}))),React.createElement("div",null,React.createElement("label",{className:"block text-xs font-semibold text-slate-500 uppercase mb-1"},"Cuenta"),React.createElement("select",{value:selectedAccount,onChange:function onChange(event){return setSelectedAccount(event.target.value)},className:"border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white",disabled:!accountOptions.length},React.createElement("option",{value:"all"},"Todas"),accountOptions.map(function(option){return React.createElement("option",{key:option.value,value:option.value},option.label)}))),React.createElement("div",{className:"flex flex-col gap-1"},React.createElement("span",{className:"block text-xs font-semibold text-slate-500 uppercase"},"Estado"),React.createElement(StatusFilter,{value:statusFilter,onChange:setStatusFilter})),React.createElement("div",{className:"flex items-center gap-2 text-sm text-slate-600"},React.createElement(Badge,{tone:kpi.periodTone},kpi.periodStatus),React.createElement("span",null,kpi.periodHint))))),selectedAccount!=="all"&&accountOptionMap.has(selectedAccount)&&filteredRows.length===0&&React.createElement("div",{className:"max-w-7xl mx-auto px-4 pt-3"},React.createElement("div",{className:"rounded-xl border border-dashed border-slate-300 bg-slate-50 px-4 py-3 text-sm text-slate-600"},"Sin movimientos este mes para ",((_accountOptionMap$get=accountOptionMap.get(selectedAccount))===null||_accountOptionMap$get===void 0?void 0:_accountOptionMap$get.baseLabel)||"esta cuenta",".")),React.createElement("div",{className:"max-w-7xl mx-auto px-4 py-4 grid grid-cols-2 md:grid-cols-4 gap-3"},React.createElement(Kpi,{label:"Conciliados",value:kpi.conciliated,hint:"",tone:"success"}),React.createElement(Kpi,{label:"Pendientes",value:kpi.pending,hint:""}),React.createElement(Kpi,{label:"Auto-Match %",value:"".concat(kpi.autoMatch,"%")}),React.createElement(Kpi,{label:"Estado del periodo",value:kpi.periodStatus,hint:kpi.periodHint,tone:kpi.periodTone})),React.createElement("div",{className:"max-w-7xl mx-auto px-4 pb-10 space-y-6"},React.createElement("div",{className:"rounded-2xl border bg-white shadow-sm overflow-hidden"},React.createElement(ColumnHeader,{iconClass:"fas fa-bolt text-emerald-600",title:"Listas para aprobar (IA \u226585%)",subtitle:"Revisa y concilia en 1 clic",tone:"success",cta:React.createElement("button",{className:"inline-flex items-center gap-2 rounded-xl bg-slate-900 text-white px-3 py-1.5 text-sm"},React.createElement("i",{className:"fas fa-check-circle"})," Conciliar ( ",groups.aiReady.length," )")}),React.createElement(SmartTableHeader,null),groups.aiReady.map(function(row){return React.createElement(Row,{key:row.id,row:row,onOpenDrawer:setDrawerRow,expandedId:expandedId,setExpandedId:setExpandedId})}),groups.aiReady.length===0&&React.createElement("div",{className:"px-6 py-10 text-center text-sm text-slate-500"},"No hay movimientos listos para aprobar.")),React.createElement("div",{className:"rounded-2xl border bg-white shadow-sm overflow-hidden"},React.createElement(ColumnHeader,{iconClass:"fas fa-circle-question text-amber-600",title:"Revisi\xF3n manual",subtitle:"Te mostramos 3 mejores coincidencias",tone:"warning"}),React.createElement(SmartTableHeader,null),groups.manual.map(function(row){return React.createElement(Row,{key:row.id,row:row,onOpenDrawer:setDrawerRow,expandedId:expandedId,setExpandedId:setExpandedId})}),groups.manual.length===0&&React.createElement("div",{className:"px-6 py-10 text-center text-sm text-slate-500"},"Sin movimientos en revisi\xF3n manual.")),React.createElement("div",{className:"rounded-2xl border bg-white shadow-sm overflow-hidden"},React.createElement(ColumnHeader,{iconClass:"fas fa-badge-percent text-amber-600",title:"PPD / Complementos de pago",subtitle:"Gestiona parcialidades, complementos y conciliaci\xF3n provisional",tone:"warning",cta:React.createElement("div",{className:"flex items-center gap-2"},React.createElement("button",{className:"rounded-xl border px-3 py-1.5 text-sm"},"Registrar complemento"),React.createElement("button",{className:"rounded-xl border px-3 py-1.5 text-sm"},"Conciliar provisional (visibles)"))}),React.createElement(SmartTableHeader,null),groups.ppd.map(function(row){return React.createElement(Row,{key:row.id,row:row,onOpenDrawer:setDrawerRow,expandedId:expandedId,setExpandedId:setExpandedId})}),groups.ppd.length===0&&React.createElement("div",{className:"px-6 py-10 text-center text-sm text-slate-500"},"No hay pagos PPD pendientes.")),React.createElement("div",{className:"rounded-2xl border bg-white shadow-sm overflow-hidden"},React.createElement(ColumnHeader,{iconClass:"fas fa-globe text-blue-600",title:"Servicios/Productos Internacionales (sin CFDI)",subtitle:"Pagos al extranjero sin CFDI: adjunta factura extranjera o marca excepci\xF3n",tone:"warning",cta:React.createElement("div",{className:"flex items-center gap-2"},React.createElement("button",{className:"rounded-xl border px-3 py-1.5 text-sm"},"Adjuntar factura extranjera"),React.createElement("button",{className:"rounded-xl border px-3 py-1.5 text-sm"},"Marcar no deducible"))}),React.createElement(SmartTableHeader,null),groups.intl.map(function(row){return React.createElement(Row,{key:row.id,row:row,onOpenDrawer:setDrawerRow,expandedId:expandedId,setExpandedId:setExpandedId})}),groups.intl.length===0&&React.createElement("div",{className:"px-6 py-10 text-center text-sm text-slate-500"},"No se detectaron movimientos internacionales sin CFDI.")),React.createElement("div",{className:"rounded-2xl border bg-white shadow-sm overflow-hidden"},React.createElement(ColumnHeader,{iconClass:"fas fa-receipt text-red-600",title:"Falta CFDI",subtitle:"Crea gasto o busca CFDI para cerrar",tone:"danger",cta:React.createElement("div",{className:"flex items-center gap-2"},React.createElement("button",{className:"rounded-xl border px-3 py-1.5 text-sm"},"Crear gasto"),React.createElement("button",{className:"rounded-xl border px-3 py-1.5 text-sm"},"Buscar CFDI"))}),React.createElement(SmartTableHeader,null),groups.missingCfdi.map(function(row){return React.createElement(Row,{key:row.id,row:row,onOpenDrawer:setDrawerRow,expandedId:expandedId,setExpandedId:setExpandedId})}),groups.missingCfdi.length===0&&React.createElement("div",{className:"px-6 py-10 text-center text-sm text-slate-500"},"No hay movimientos sin CFDI.")),React.createElement("div",{className:"rounded-2xl border bg-white shadow-sm overflow-hidden"},React.createElement(ColumnHeader,{iconClass:"fas fa-link text-slate-600",title:"Transferencias / Propias",subtitle:"Detectamos CLABE/Titular para proponer traspaso"}),React.createElement(SmartTableHeader,null),groups.transfers.map(function(row){return React.createElement(Row,{key:row.id,row:row,onOpenDrawer:setDrawerRow,expandedId:expandedId,setExpandedId:setExpandedId})}),groups.transfers.length===0&&React.createElement("div",{className:"px-6 py-10 text-center text-sm text-slate-500"},"No hay transferencias internas detectadas."))),React.createElement(Drawer,{open:Boolean(drawerRow),onClose:function onClose(){return setDrawerRow(null)},row:drawerRow,onConciliate:handleConciliate,conciliateLoading:conciliateLoading}),React.createElement(SatImportModal,{isOpen:satModalOpen,onClose:function onClose(){return setSatModalOpen(false)},onProcessed:loadMovements}))};var rootElement=document.getElementById("bank-reconciliation-root");if(rootElement){var root=ReactDOM.createRoot(rootElement);root.render(React.createElement(BankReconciliationApp,null))}
