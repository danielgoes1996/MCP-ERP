{
  "systemMetrics": {
    "totalFunctionalities": 23,
    "globalCoherence": 71,
    "mappedDependencies": 147,
    "criticalSPOFs": 3,
    "pythonFiles": 173,
    "apiEndpoints": 38,
    "missingBDFields": 23,
    "missingUIFields": 15
  },
  "categoryStats": {
    "core": {
      "functionalities": 4,
      "averageCoherence": 78,
      "risk": "medium"
    },
    "business": {
      "functionalities": 11,
      "averageCoherence": 69,
      "risk": "high"
    },
    "intelligence": {
      "functionalities": 8,
      "averageCoherence": 72,
      "risk": "medium"
    }
  },
  "spofs": [
    {
      "name": "Base de Datos SQLite",
      "affects": "96%",
      "recoveryTime": "4-8 hours",
      "severity": "critical"
    },
    {
      "name": "FastAPI Framework",
      "affects": "78%",
      "recoveryTime": "1-2 hours",
      "severity": "medium"
    },
    {
      "name": "Modelos Pydantic",
      "affects": "65%",
      "recoveryTime": "2-4 hours",
      "severity": "medium"
    }
  ],
  "circularDependencies": [
    {
      "name": "Gastos ‚Üî Facturas ‚Üî Conciliaci√≥n",
      "risk": "Deadlocks en actualizaciones concurrentes",
      "solution": "Event-driven architecture"
    },
    {
      "name": "Automatizaci√≥n ‚Üî Persistencia ‚Üî Worker",
      "risk": "State inconsistency",
      "solution": "Saga pattern"
    },
    {
      "name": "Analytics ‚Üî Completado ‚Üî Predicci√≥n",
      "risk": "Infinite loops en ML",
      "solution": "Circuit breaker pattern"
    }
  ],
  "functionalities": [
    {
      "id": 1,
      "name": "Sistema MCP",
      "category": "core",
      "coherence": 88,
      "criticality": "maxima",
      "isSPOF": false,
      "layer": "core",
      "icon": "üìä",
      "description": "Model Context Protocol - Comunicaci√≥n con agentes AI",
      "dependencies": ["Base de datos SQLite", "FastAPI framework", "Modelos Pydantic core"],
      "mainFlows": ["Comunicaci√≥n con agentes AI", "Procesamiento de requests/responses", "Coordinaci√≥n inter-modular"],
      "fields": {
        "method": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "params": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "success": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "error_details": { "bd": false, "api": true, "ui": true, "status": "missing_bd" }
      },
      "status": {
        "security": "alta",
        "performance": "media",
        "coherence": 88
      },
      "relatedFiles": ["main.py", "core/api_models.py"],
      "endpoints": ["/mcp/request", "/mcp/response"],
      "uiComponents": ["mcp-handler.js"]
    },
    {
      "id": 2,
      "name": "Base de Datos SQLite",
      "category": "core",
      "coherence": 65,
      "criticality": "maxima",
      "isSPOF": true,
      "layer": "core",
      "icon": "üóÑÔ∏è",
      "description": "Persistencia principal del sistema - SPOF cr√≠tico",
      "dependencies": ["Archivo expenses.db", "Migraciones pendientes"],
      "mainFlows": ["Persistencia de datos", "Consultas transaccionales", "Backup/Recovery"],
      "fields": {
        "tables_created": { "bd": true, "api": true, "ui": false, "status": "missing_ui" },
        "migrations": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "backup_status": { "bd": true, "api": false, "ui": false, "status": "missing_api_ui" }
      },
      "status": {
        "security": "media",
        "performance": "baja",
        "coherence": 65
      },
      "relatedFiles": ["expenses.db", "migrations/"],
      "sqlIssues": [
        "ALTER TABLE expenses ADD COLUMN deducible BOOLEAN DEFAULT TRUE;",
        "ALTER TABLE expenses ADD COLUMN centro_costo TEXT;",
        "ALTER TABLE expenses ADD COLUMN proyecto TEXT;"
      ]
    },
    {
      "id": 3,
      "name": "Sistema de Autenticaci√≥n",
      "category": "core",
      "coherence": 82,
      "criticality": "maxima",
      "isSPOF": false,
      "layer": "core",
      "icon": "üîê",
      "description": "Gesti√≥n de usuarios y multi-tenancy",
      "dependencies": ["Usuarios table", "JWT tokens", "Company_id validation"],
      "mainFlows": ["Registro/Login de usuarios", "Gesti√≥n de sesiones", "Multi-tenancy por empresa"],
      "fields": {
        "user_id": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "company_id": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "session_token": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "permissions": { "bd": true, "api": false, "ui": true, "status": "missing_api" }
      },
      "status": {
        "security": "alta",
        "performance": "alta",
        "coherence": 82
      },
      "relatedFiles": ["core/auth_system.py", "static/onboarding.html"],
      "endpoints": ["/auth/login", "/auth/register", "/auth/validate"]
    },
    {
      "id": 4,
      "name": "Manejo de Errores",
      "category": "core",
      "coherence": 78,
      "criticality": "alta",
      "isSPOF": false,
      "layer": "core",
      "icon": "‚ö†Ô∏è",
      "description": "Sistema centralizado de gesti√≥n de errores",
      "dependencies": ["Logger system", "Exception handlers", "Error response models"],
      "mainFlows": ["Captura de excepciones", "Logging estructurado", "Respuestas HTTP coherentes"],
      "fields": {
        "error_code": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "message": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "stack_trace": { "bd": false, "api": true, "ui": false, "status": "intentional" },
        "user_context": { "bd": false, "api": true, "ui": true, "status": "missing_bd" }
      },
      "status": {
        "security": "alta",
        "performance": "alta",
        "coherence": 78
      },
      "relatedFiles": ["core/error_handler.py"],
      "endpoints": ["/health", "/errors/log"]
    },
    {
      "id": 5,
      "name": "Gesti√≥n de Gastos",
      "category": "business",
      "coherence": 74,
      "criticality": "maxima",
      "isSPOF": false,
      "layer": "business",
      "icon": "üí∞",
      "description": "CRUD de gastos con validaci√≥n y categorizaci√≥n",
      "dependencies": ["expenses table", "ExpenseCreate/Response models", "voice-expenses.html UI"],
      "mainFlows": ["CRUD de gastos", "Validaci√≥n de montos/monedas", "Integraci√≥n con facturas"],
      "fields": {
        "descripcion": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "monto_total": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "fecha_gasto": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "proveedor": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "categoria": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "deducible": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "centro_costo": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "proyecto": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "tags": { "bd": false, "api": true, "ui": false, "status": "missing_bd_ui" }
      },
      "status": {
        "security": "media",
        "performance": "media",
        "coherence": 74
      },
      "relatedFiles": ["core/expense_models.py", "static/voice-expenses.html", "main.py"],
      "endpoints": ["/expenses", "/expenses/{id}", "/expenses/create"],
      "uiComponents": ["voice-expenses.html", "expense-form.js"],
      "sampleRequest": {
        "descripcion": "Gasolina para veh√≠culo empresa",
        "monto_total": 850.00,
        "fecha_gasto": "2024-09-25",
        "proveedor": "Gasoliner√≠a Litro Mil",
        "categoria": "Combustible",
        "deducible": true,
        "centro_costo": "Ventas",
        "proyecto": "Proyecto ABC",
        "company_id": "default"
      },
      "sampleResponse": {
        "id": 123,
        "descripcion": "Gasolina para veh√≠culo empresa",
        "monto_total": 850.00,
        "estado": "pendiente",
        "created_at": "2024-09-25T10:30:00Z"
      }
    },
    {
      "id": 6,
      "name": "Procesamiento de Facturas",
      "category": "business",
      "coherence": 69,
      "criticality": "alta",
      "isSPOF": false,
      "layer": "business",
      "icon": "üìÑ",
      "description": "OCR y parsing de facturas XML/PDF",
      "dependencies": ["invoices table", "OCR/PDF parsing", "Invoice matching algorithms"],
      "mainFlows": ["Upload de PDFs/XMLs", "Extracci√≥n de datos", "Matching con gastos"],
      "fields": {
        "uuid": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "rfc_emisor": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "total": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "subtotal": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "iva_amount": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "xml_content": { "bd": true, "api": false, "ui": false, "status": "missing_api" }
      },
      "status": {
        "security": "media",
        "performance": "baja",
        "coherence": 69
      },
      "relatedFiles": ["modules/invoicing_agent/", "static/advanced-ticket-dashboard.html"]
    },
    {
      "id": 7,
      "name": "Conciliaci√≥n Bancaria",
      "category": "business",
      "coherence": 68,
      "criticality": "alta",
      "isSPOF": false,
      "layer": "business",
      "icon": "üîÑ",
      "description": "Matching autom√°tico de movimientos bancarios",
      "dependencies": ["bank_movements table", "Algoritmos de matching", "ML suggestion engine"],
      "mainFlows": ["Import movimientos bancarios", "Matching autom√°tico", "Sugerencias ML"],
      "fields": {
        "movement_id": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "amount": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "confidence": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "decision": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "bank_metadata": { "bd": true, "api": false, "ui": true, "status": "missing_api" }
      },
      "status": {
        "security": "media",
        "performance": "baja",
        "coherence": 68
      }
    },
    {
      "id": 17,
      "name": "Motor de Automatizaci√≥n RPA",
      "category": "intelligence",
      "coherence": 62,
      "criticality": "alta",
      "isSPOF": false,
      "layer": "intelligence",
      "icon": "üé≠",
      "description": "Playwright engine para automatizaci√≥n web",
      "dependencies": ["Playwright engine", "Portal templates", "Screenshot management"],
      "mainFlows": ["Navegaci√≥n automatizada", "Extracci√≥n de datos web", "Gesti√≥n de sesiones"],
      "fields": {
        "portal_config": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "automation_steps": { "bd": true, "api": true, "ui": true, "status": "complete" },
        "session_state": { "bd": false, "api": true, "ui": true, "status": "missing_bd" },
        "screenshot_metadata": { "bd": true, "api": false, "ui": true, "status": "missing_api" },
        "error_recovery": { "bd": false, "api": true, "ui": true, "status": "missing_bd" }
      },
      "status": {
        "security": "baja",
        "performance": "muy_baja",
        "coherence": 62
      },
      "relatedFiles": ["modules/invoicing_agent/playwright_automation_engine.py"]
    }
  ],
  "missingFields": {
    "critical": [
      { "table": "expenses", "field": "deducible", "type": "BOOLEAN", "default": "TRUE" },
      { "table": "expenses", "field": "centro_costo", "type": "TEXT" },
      { "table": "expenses", "field": "proyecto", "type": "TEXT" },
      { "table": "expenses", "field": "tags", "type": "JSON" }
    ],
    "medium": [
      { "table": "invoices", "field": "subtotal", "type": "DECIMAL(10,2)" },
      { "table": "invoices", "field": "iva_amount", "type": "DECIMAL(10,2)" },
      { "table": "bank_movements", "field": "decision", "type": "TEXT" }
    ],
    "low": [
      { "table": "automation_sessions", "field": "checkpoint_data", "type": "JSON" },
      { "table": "workers", "field": "progress", "type": "DECIMAL(3,2)" }
    ]
  },
  "strengtheningPlan": {
    "phase1": {
      "name": "Estabilizaci√≥n Core",
      "duration": "4 semanas",
      "objective": "Coherencia Core 78% ‚Üí 92%",
      "tasks": ["Migraci√≥n SQLite ‚Üí PostgreSQL", "Implementar campos faltantes BD", "Clustering de base de datos", "Monitoreo de SPOFs"]
    },
    "phase2": {
      "name": "Business Logic",
      "duration": "6 semanas",
      "objective": "Coherencia Business 69% ‚Üí 88%",
      "tasks": ["Completar campos UI ‚Üî API ‚Üî BD", "Implementar audit trails", "Optimizar queries de analytics", "Resolver dependencias circulares"]
    },
    "phase3": {
      "name": "Intelligence Layer",
      "duration": "4 semanas",
      "objective": "Coherencia Intelligence 64% ‚Üí 85%",
      "tasks": ["Optimizar performance RPA", "Implementar circuit breakers", "Mejorar error recovery", "Documentar APIs faltantes"]
    },
    "phase4": {
      "name": "Optimizaci√≥n Final",
      "duration": "2 semanas",
      "objective": "Coherencia Global 71% ‚Üí 91%",
      "tasks": ["Testing integral E2E", "Security audit completo", "Performance tuning", "Documentaci√≥n usuario"]
    }
  }
}