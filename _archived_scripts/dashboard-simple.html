<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç MCP Audit Dashboard - Sistema Completo</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Heroicons CSS -->
    <style>
        .hero-icon { width: 1.25rem; height: 1.25rem; }
        .hero-icon-sm { width: 1rem; height: 1rem; }
        .hero-icon-lg { width: 1.5rem; height: 1.5rem; }

        .functionality-card {
            transition: all 0.2s ease-in-out;
        }
        .functionality-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .badge-complete { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-warning { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .badge-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .pulse-slow { animation: pulse 3s ease-in-out infinite; }

        pre code {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            display: block;
            overflow-x: auto;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="dashboard-root"></div>

    <script type="text/babel">
        // ===== DATOS DE AUDITOR√çA COMPLETOS =====
        const auditData = {
            systemMetrics: {
                totalFunctionalities: 23,
                globalCoherence: 71,
                mappedDependencies: 147,
                criticalSPOFs: 3,
                pythonFiles: 173,
                apiEndpoints: 38,
                missingBDFields: 23,
                missingUIFields: 15
            },
            categoryStats: {
                core: { functionalities: 4, averageCoherence: 78, risk: "medium" },
                business: { functionalities: 11, averageCoherence: 69, risk: "high" },
                intelligence: { functionalities: 8, averageCoherence: 72, risk: "medium" }
            },
            spofs: [
                {
                    name: "Base de Datos SQLite",
                    affects: "96%",
                    recoveryTime: "4-8 hours",
                    severity: "critical"
                },
                {
                    name: "FastAPI Framework",
                    affects: "78%",
                    recoveryTime: "1-2 hours",
                    severity: "medium"
                },
                {
                    name: "Modelos Pydantic",
                    affects: "65%",
                    recoveryTime: "2-4 hours",
                    severity: "medium"
                }
            ],
            circularDependencies: [
                {
                    name: "Gastos ‚Üî Facturas ‚Üî Conciliaci√≥n",
                    risk: "Deadlocks en actualizaciones concurrentes",
                    solution: "Event-driven architecture"
                },
                {
                    name: "Automatizaci√≥n ‚Üî Persistencia ‚Üî Worker",
                    risk: "State inconsistency",
                    solution: "Saga pattern"
                },
                {
                    name: "Analytics ‚Üî Completado ‚Üî Predicci√≥n",
                    risk: "Infinite loops en ML",
                    solution: "Circuit breaker pattern"
                }
            ],
            functionalities: [
                {
                    id: 1,
                    name: "Sistema MCP",
                    category: "core",
                    coherence: 88,
                    criticality: "maxima",
                    isSPOF: false,
                    icon: "üìä",
                    description: "Model Context Protocol - Comunicaci√≥n con agentes AI",
                    fields: {
                        "method": { bd: true, api: true, ui: true, status: "complete" },
                        "params": { bd: true, api: true, ui: true, status: "complete" },
                        "success": { bd: true, api: true, ui: true, status: "complete" },
                        "error_details": { bd: false, api: true, ui: true, status: "missing_bd" }
                    },
                    status: { security: "alta", performance: "media", coherence: 88 }
                },
                {
                    id: 2,
                    name: "Base de Datos SQLite",
                    category: "core",
                    coherence: 65,
                    criticality: "maxima",
                    isSPOF: true,
                    icon: "üóÑÔ∏è",
                    description: "Persistencia principal del sistema - SPOF cr√≠tico",
                    fields: {
                        "tables_created": { bd: true, api: true, ui: false, status: "missing_ui" },
                        "migrations": { bd: false, api: true, ui: true, status: "missing_bd" },
                        "backup_status": { bd: true, api: false, ui: false, status: "missing_api_ui" }
                    },
                    status: { security: "media", performance: "baja", coherence: 65 },
                    sqlIssues: [
                        "ALTER TABLE expenses ADD COLUMN deducible BOOLEAN DEFAULT TRUE;",
                        "ALTER TABLE expenses ADD COLUMN centro_costo TEXT;",
                        "ALTER TABLE expenses ADD COLUMN proyecto TEXT;"
                    ]
                },
                {
                    id: 5,
                    name: "Gesti√≥n de Gastos",
                    category: "business",
                    coherence: 74,
                    criticality: "maxima",
                    isSPOF: false,
                    icon: "üí∞",
                    description: "CRUD de gastos con validaci√≥n y categorizaci√≥n",
                    fields: {
                        "descripcion": { bd: true, api: true, ui: true, status: "complete" },
                        "monto_total": { bd: true, api: true, ui: true, status: "complete" },
                        "fecha_gasto": { bd: true, api: true, ui: true, status: "complete" },
                        "deducible": { bd: false, api: true, ui: true, status: "missing_bd" },
                        "centro_costo": { bd: false, api: true, ui: true, status: "missing_bd" },
                        "proyecto": { bd: false, api: true, ui: true, status: "missing_bd" }
                    },
                    status: { security: "media", performance: "media", coherence: 74 },
                    sampleRequest: {
                        descripcion: "Gasolina para veh√≠culo empresa",
                        monto_total: 850.00,
                        fecha_gasto: "2024-09-25",
                        deducible: true,
                        centro_costo: "Ventas"
                    },
                    sampleResponse: {
                        id: 123,
                        descripcion: "Gasolina para veh√≠culo empresa",
                        monto_total: 850.00,
                        estado: "pendiente"
                    }
                },
                {
                    id: 17,
                    name: "Motor de Automatizaci√≥n RPA",
                    category: "intelligence",
                    coherence: 62,
                    criticality: "alta",
                    isSPOF: false,
                    icon: "üé≠",
                    description: "Playwright engine para automatizaci√≥n web",
                    fields: {
                        "portal_config": { bd: true, api: true, ui: true, status: "complete" },
                        "automation_steps": { bd: true, api: true, ui: true, status: "complete" },
                        "session_state": { bd: false, api: true, ui: true, status: "missing_bd" },
                        "error_recovery": { bd: false, api: true, ui: true, status: "missing_bd" }
                    },
                    status: { security: "baja", performance: "muy_baja", coherence: 62 }
                }
            ],
            missingFields: {
                critical: [
                    { table: "expenses", field: "deducible", type: "BOOLEAN", default: "TRUE" },
                    { table: "expenses", field: "centro_costo", type: "TEXT" },
                    { table: "expenses", field: "proyecto", type: "TEXT" },
                    { table: "expenses", field: "tags", type: "JSON" }
                ],
                medium: [
                    { table: "invoices", field: "subtotal", type: "DECIMAL(10,2)" },
                    { table: "invoices", field: "iva_amount", type: "DECIMAL(10,2)" }
                ]
            }
        };

        // ===== COMPONENTES DEL DASHBOARD =====

        const Dashboard = () => {
            const [selectedCategory, setSelectedCategory] = React.useState('all');
            const [expandedFunctionality, setExpandedFunctionality] = React.useState(null);
            const [showAdvanced, setShowAdvanced] = React.useState(false);

            const getCoherenceColor = (coherence) => {
                if (coherence >= 80) return 'text-green-600 bg-green-100';
                if (coherence >= 70) return 'text-yellow-600 bg-yellow-100';
                return 'text-red-600 bg-red-100';
            };

            const getCriticalityColor = (criticality) => {
                switch(criticality) {
                    case 'maxima': return 'bg-red-500 text-white';
                    case 'alta': return 'bg-orange-500 text-white';
                    case 'media': return 'bg-yellow-500 text-white';
                    default: return 'bg-gray-500 text-white';
                }
            };

            const filteredFunctionalities = auditData.functionalities.filter(func => {
                if (selectedCategory === 'all') return true;
                return func.category === selectedCategory;
            });

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    {/* Header */}
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">
                            üîç Dashboard de Auditor√≠a - Sistema MCP Server
                        </h1>
                        <p className="text-gray-600">
                            An√°lisis integral de 23 funcionalidades, coherencia arquitect√≥nica y dependencias cr√≠ticas
                        </p>
                    </div>

                    {/* M√©tricas Principales */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white rounded-lg shadow p-6 border">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-gray-600">Funcionalidades</span>
                                <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    ‚úÖ Completo
                                </span>
                            </div>
                            <div className="text-2xl font-bold text-gray-900">23</div>
                            <p className="text-xs text-gray-500">Total auditadas</p>
                        </div>

                        <div className="bg-white rounded-lg shadow p-6 border">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-gray-600">Coherencia</span>
                                <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    ‚ö†Ô∏è Mejorar
                                </span>
                            </div>
                            <div className="text-2xl font-bold text-yellow-600">71%</div>
                            <p className="text-xs text-gray-500">Objetivo: 91%</p>
                        </div>

                        <div className="bg-white rounded-lg shadow p-6 border">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-gray-600">SPOFs</span>
                                <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    üî¥ Cr√≠tico
                                </span>
                            </div>
                            <div className="text-2xl font-bold text-red-600">3</div>
                            <p className="text-xs text-gray-500">Puntos de falla</p>
                        </div>

                        <div className="bg-white rounded-lg shadow p-6 border">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-gray-600">Dependencias</span>
                                <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ‚úÖ Mapeadas
                                </span>
                            </div>
                            <div className="text-2xl font-bold text-gray-900">147+</div>
                            <p className="text-xs text-gray-500">Relaciones</p>
                        </div>
                    </div>

                    {/* SPOFs Cr√≠ticos */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">
                                üö® Single Points of Failure
                            </h3>
                            <div className="space-y-4">
                                {auditData.spofs.map((spof, index) => (
                                    <div key={index} className={`border rounded-lg p-4 ${
                                        spof.severity === 'critical' ? 'bg-red-50 border-red-300' :
                                        spof.severity === 'medium' ? 'bg-yellow-50 border-yellow-300' :
                                        'bg-gray-50 border-gray-300'
                                    }`}>
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <h4 className="font-semibold text-lg mb-1">{spof.name}</h4>
                                                <p className="text-sm"><strong>Impacto:</strong> {spof.affects} del sistema</p>
                                                <p className="text-sm"><strong>Recovery:</strong> {spof.recoveryTime}</p>
                                            </div>
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                spof.severity === 'critical' ? 'bg-red-500 text-white' :
                                                'bg-yellow-500 text-white'
                                            }`}>
                                                {spof.severity.toUpperCase()}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">
                                üîÑ Dependencias Circulares
                            </h3>
                            <div className="space-y-4">
                                {auditData.circularDependencies.map((dep, index) => (
                                    <div key={index} className="border rounded-lg p-4 bg-orange-50 border-orange-300">
                                        <h4 className="font-semibold mb-2">{dep.name}</h4>
                                        <p className="text-sm text-orange-700 mb-2">
                                            <strong>Riesgo:</strong> {dep.risk}
                                        </p>
                                        <p className="text-sm text-blue-700">
                                            <strong>Soluci√≥n:</strong> {dep.solution}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Filtros */}
                    <div className="bg-white rounded-lg shadow p-6 mb-6">
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center space-x-4">
                                <label className="text-sm font-medium text-gray-700">Filtrar por capa:</label>
                                <select
                                    value={selectedCategory}
                                    onChange={(e) => setSelectedCategory(e.target.value)}
                                    className="border border-gray-300 rounded-md px-3 py-2 text-sm"
                                >
                                    <option value="all">Todas las funcionalidades</option>
                                    <option value="core">Capa Core (4)</option>
                                    <option value="business">Capa Business (11)</option>
                                    <option value="intelligence">Capa Intelligence (8)</option>
                                </select>
                            </div>
                            <button
                                onClick={() => setShowAdvanced(!showAdvanced)}
                                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
                            >
                                {showAdvanced ? 'Vista Simple' : 'Vista Avanzada'}
                            </button>
                        </div>
                    </div>

                    {/* Lista de Funcionalidades */}
                    <div className="space-y-4">
                        <h2 className="text-xl font-semibold text-gray-900">
                            Funcionalidades del Sistema ({filteredFunctionalities.length})
                        </h2>

                        {filteredFunctionalities.map((functionality) => (
                            <div key={functionality.id} className="functionality-card bg-white rounded-lg shadow border overflow-hidden">
                                <div
                                    className="p-4 cursor-pointer hover:bg-gray-50"
                                    onClick={() => setExpandedFunctionality(
                                        expandedFunctionality === functionality.id ? null : functionality.id
                                    )}
                                >
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-4">
                                            <span className="text-2xl">{functionality.icon}</span>
                                            <div>
                                                <h3 className="text-lg font-semibold text-gray-900">
                                                    {functionality.name}
                                                </h3>
                                                <p className="text-sm text-gray-600">{functionality.description}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center space-x-4">
                                            {functionality.isSPOF && (
                                                <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    üö® SPOF
                                                </span>
                                            )}
                                            <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getCriticalityColor(functionality.criticality)}`}>
                                                {functionality.criticality.toUpperCase()}
                                            </span>
                                            <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getCoherenceColor(functionality.coherence)}`}>
                                                {functionality.coherence}%
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Contenido expandido */}
                                {expandedFunctionality === functionality.id && (
                                    <div className="border-t border-gray-200 p-4 space-y-6">
                                        {/* Estado actual */}
                                        <div>
                                            <h4 className="text-sm font-semibold text-gray-900 mb-3">üìä Estado Actual</h4>
                                            <div className="grid grid-cols-3 gap-4">
                                                <div className="text-center">
                                                    <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                                        functionality.status.security === 'alta' ? 'bg-green-100 text-green-800' :
                                                        functionality.status.security === 'media' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}>
                                                        üîí {functionality.status.security.toUpperCase()}
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-1">Seguridad</p>
                                                </div>
                                                <div className="text-center">
                                                    <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                                        functionality.status.performance === 'alta' ? 'bg-green-100 text-green-800' :
                                                        functionality.status.performance === 'media' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}>
                                                        ‚ö° {functionality.status.performance.toUpperCase()}
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-1">Performance</p>
                                                </div>
                                                <div className="text-center">
                                                    <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getCoherenceColor(functionality.status.coherence)}`}>
                                                        üîÑ {functionality.status.coherence}%
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-1">Coherencia</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Trazabilidad de campos */}
                                        <div>
                                            <h4 className="text-sm font-semibold text-gray-900 mb-3">
                                                üîó Trazabilidad BD ‚Üî API ‚Üî UI
                                            </h4>
                                            <div className="space-y-2">
                                                {Object.entries(functionality.fields).map(([fieldName, field]) => (
                                                    <div key={fieldName} className={`border rounded-lg p-3 ${
                                                        field.status === 'complete' ? 'bg-green-50 border-green-200' :
                                                        'bg-yellow-50 border-yellow-200'
                                                    }`}>
                                                        <div className="flex items-center justify-between">
                                                            <code className="text-sm font-medium">{fieldName}</code>
                                                            <div className="flex space-x-1">
                                                                <span className={`px-2 py-1 rounded text-xs ${
                                                                    field.bd ? 'badge-complete' : 'badge-danger'
                                                                }`}>
                                                                    BD {field.bd ? '‚úì' : '‚úó'}
                                                                </span>
                                                                <span className={`px-2 py-1 rounded text-xs ${
                                                                    field.api ? 'badge-complete' : 'badge-danger'
                                                                }`}>
                                                                    API {field.api ? '‚úì' : '‚úó'}
                                                                </span>
                                                                <span className={`px-2 py-1 rounded text-xs ${
                                                                    field.ui ? 'badge-complete' : 'badge-danger'
                                                                }`}>
                                                                    UI {field.ui ? '‚úì' : '‚úó'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Sample Request/Response */}
                                        {functionality.sampleRequest && (
                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <div>
                                                    <h5 className="text-xs font-medium text-gray-700 mb-2">üì§ Sample Request</h5>
                                                    <pre className="text-xs"><code>{JSON.stringify(functionality.sampleRequest, null, 2)}</code></pre>
                                                </div>
                                                {functionality.sampleResponse && (
                                                    <div>
                                                        <h5 className="text-xs font-medium text-gray-700 mb-2">üì• Sample Response</h5>
                                                        <pre className="text-xs"><code>{JSON.stringify(functionality.sampleResponse, null, 2)}</code></pre>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {/* SQL Issues */}
                                        {functionality.sqlIssues && (
                                            <div>
                                                <h4 className="text-sm font-semibold text-red-600 mb-3">
                                                    üîß Scripts SQL Requeridos
                                                </h4>
                                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                                    {functionality.sqlIssues.map((sql, index) => (
                                                        <pre key={index} className="text-xs mb-2 last:mb-0"><code>{sql}</code></pre>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Scripts SQL Completos (Vista Avanzada) */}
                    {showAdvanced && (
                        <div className="mt-8 bg-white rounded-lg shadow p-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">
                                üîß Scripts SQL de Correcci√≥n Completos
                            </h3>
                            <div className="space-y-4">
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <h4 className="font-medium text-red-800 mb-3">PRIORIDAD CR√çTICA</h4>
                                    <pre className="text-sm"><code>
{auditData.missingFields.critical.map(field =>
`ALTER TABLE ${field.table} ADD COLUMN ${field.field} ${field.type}${field.default ? ` DEFAULT ${field.default}` : ''};`
).join('\n')}
                                    </code></pre>
                                </div>
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <h4 className="font-medium text-yellow-800 mb-3">PRIORIDAD MEDIA</h4>
                                    <pre className="text-sm"><code>
{auditData.missingFields.medium.map(field =>
`ALTER TABLE ${field.table} ADD COLUMN ${field.field} ${field.type};`
).join('\n')}
                                    </code></pre>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
                        <p>üìÖ Dashboard generado: {new Date().toLocaleDateString('es-ES')} | üîÑ Basado en AUDITORIA_MAESTRA_SISTEMA_MCP.md</p>
                        <p>‚úÖ {auditData.systemMetrics.totalFunctionalities} funcionalidades ‚Ä¢ ‚ö†Ô∏è {auditData.systemMetrics.globalCoherence}% coherencia ‚Ä¢ üö® {auditData.systemMetrics.criticalSPOFs} SPOFs</p>
                    </div>
                </div>
            );
        };

        // Renderizar el dashboard
        const root = ReactDOM.createRoot(document.getElementById('dashboard-root'));
        root.render(<Dashboard />);

        // Exponer utilidades globales
        window.MCPAuditDashboard = {
            data: auditData,
            exportCSV: () => {
                const csv = auditData.functionalities.map(f =>
                    `${f.id},${f.name},${f.category},${f.coherence},${f.criticality},${f.isSPOF ? 'S√≠' : 'No'}`
                ).join('\n');
                console.log('ID,Nombre,Categor√≠a,Coherencia,Criticidad,SPOF\n' + csv);
                return csv;
            },
            info: () => {
                console.log('üîç MCP Audit Dashboard - Sistema Completo');
                console.log('==========================================');
                console.log(`üìä ${auditData.systemMetrics.totalFunctionalities} Funcionalidades auditadas`);
                console.log(`üîÑ ${auditData.systemMetrics.globalCoherence}% Coherencia global`);
                console.log(`üö® ${auditData.systemMetrics.criticalSPOFs} SPOFs cr√≠ticos`);
                console.log(`üîó ${auditData.systemMetrics.mappedDependencies}+ Dependencias mapeadas`);
                console.log('==========================================');
                console.log('‚úÖ Dashboard completamente funcional');
            }
        };

        // Mostrar info autom√°ticamente
        console.log('üîç MCP Audit Dashboard - Sistema Completo cargado!');
        console.log('Ejecuta window.MCPAuditDashboard.info() para detalles');
    </script>
</body>
</html>